<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Streak Challenge AI â€” ToÃ¡n 9 Â· TrÆ°á»ng PTDTBT THCS MÆ°á»ng Äun</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root{--bg:#f6f8fc;--text:#0f172a;--muted:#64748b;--pri:#2563eb;--pri2:#1d4ed8;--ok:#16a34a;--bad:#dc2626;--bd:#e2e8f0;--shadow:0 18px 44px rgba(2,6,23,.10);--shadow2:0 12px 30px rgba(2,6,23,.08);--r2:22px}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1100px 380px at 10% -10%, rgba(37,99,235,.18), transparent 60%),radial-gradient(900px 360px at 90% 0%, rgba(96,165,250,.16), transparent 55%),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(246,248,252,.78);backdrop-filter:blur(14px) saturate(160%);border-bottom:1px solid var(--bd)}
    .wrap{max-width:1150px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,var(--pri),#60a5fa);box-shadow:0 18px 38px rgba(37,99,235,.26);position:relative;overflow:hidden}
    .logo:after{content:"";position:absolute;inset:-30px;background:radial-gradient(circle at 30% 20%, rgba(255,255,255,.55), transparent 40%);transform:rotate(12deg)}
    .brand h1{font-size:15px;margin:0;font-weight:900}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--bd);background:rgba(255,255,255,.7);font-size:12px}
    .btn{appearance:none;border:1px solid var(--bd);background:#fff;color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:800;box-shadow:var(--shadow2);transition:transform .08s ease, border-color .15s ease, background .15s ease}
    .btn:hover{transform:translateY(-1px);border-color:#cbd5e1} .btn:active{transform:translateY(0)}
    .btn.primary{background:var(--pri);border-color:var(--pri);color:#fff} .btn.primary:hover{background:var(--pri2)}
    .btn.ghost{background:transparent;box-shadow:none}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.wrap{padding:14px}}
    .card{background:rgba(255,255,255,.86);border:1px solid var(--bd);border-radius:var(--r2);box-shadow:var(--shadow);overflow:hidden}
    .hd{padding:14px 16px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .bd{padding:14px 16px}
    .title{font-weight:950}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    input,select,textarea{width:100%;padding:11px 12px;border:1px solid var(--bd);border-radius:14px;background:#fff;font-size:14px;outline:none}
    textarea{min-height:96px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(37,99,235,.45);box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    .hero{padding:18px 16px;border:1px solid rgba(37,99,235,.18);background:linear-gradient(135deg, rgba(37,99,235,.12), rgba(255,255,255,.55));border-radius:20px}
    .hero h2{margin:0 0 6px 0;font-size:18px;font-weight:1000}
    .hero .sub{font-size:12.5px;color:var(--muted);line-height:1.45}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{font-size:12px;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#fff}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:740px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{padding:12px;border:1px solid var(--bd);border-radius:16px;background:linear-gradient(180deg, rgba(37,99,235,.06), rgba(255,255,255,.55))}
    .kpi .num{font-size:22px;font-weight:950}
    .kpi .lab{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--bd);margin:12px 0}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0b1220;color:#fff;padding:10px 12px;border-radius:14px;opacity:0;pointer-events:none;transition:.22s;max-width:94vw;box-shadow:0 16px 40px rgba(2,6,23,.24)}
    .toast.show{opacity:1;bottom:26px}
    .hidden{display:none !important}
    .help{font-size:12.5px;color:var(--muted);line-height:1.45}
    .qbox{padding:14px;border:1px solid var(--bd);border-radius:18px;background:#fff;box-shadow:var(--shadow2)}
    .qtext{font-weight:950;margin:0 0 10px 0;font-size:15px}
    .opt{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--bd);border-radius:16px;padding:10px 12px;margin:8px 0;cursor:pointer}
    .opt:hover{border-color:#cbd5e1;background:#fbfdff}
    .opt input{width:auto;margin-top:2px}
    .opt .lab{flex:1}
    .good{color:var(--ok);font-weight:1000}
    .bad{color:var(--bad);font-weight:1000}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--bd);padding:8px 6px;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:800}
    .right{text-align:right}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:820px){.split{grid-template-columns:1fr}}
    .notice{padding:12px;border:1px dashed rgba(37,99,235,.35);border-radius:16px;background:rgba(255,255,255,.55)}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--bd);background:#fff}
  
/* ===== QR overlay (tá»‘i giáº£n) ===== */
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px;}
.modalCard{width:min(520px,100%);background:#fff;border:1px solid rgba(15,23,42,.12);border-radius:16px;box-shadow:0 24px 70px rgba(2,6,23,.35);padding:14px;}
.hidden{display:none !important;}

</style>

  <!-- XLSX (Excel) + Mammoth (DOCX) for offline import -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

</head>
<body>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Streak Challenge AI â€” ToÃ¡n 9</h1>
        <p>TrÆ°á»ng PTDTBT THCS MÆ°á»ng Äun Â· Offline/PWA Â· Import CSV Â· BÃ¡o cÃ¡o 7 ngÃ y</p>
      </div>
    </div>
    <div class="row">
      <span class="pill" id="pillMode">ChÆ°a Ä‘Äƒng nháº­p</span>
      <button class="btn ghost" id="btnInstall">â¬‡ï¸ CÃ i app</button>
      <button class="btn ghost" id="btnResetAll">ğŸ§¹ Reset</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- LOGIN -->
  <div class="grid" id="viewLogin">
    <div class="card">
      <div class="hd"><div class="title">Báº£n náº¡p dá»± Ã¡n (Submission-ready)</div><span class="pill">2 máº¡ch Â· Äáº¡i sá»‘ + HÃ¬nh há»c</span></div>
      <div class="bd">
        <div class="hero">
          <h2>â€œMá»—i ngÃ y 5 phÃºt â€” há»c Ä‘á»u 7 ngÃ yâ€</h2>
          <div class="sub">AI chá»n cÃ¢u theo <b>yÃªu cáº§u</b> + <b>lá»— há»•ng</b> + <b>Ä‘á»™ khÃ³ thÃ­ch nghi</b>. Sai quÃ¡ nhanh â†’ <b>Gate</b> gá»£i má»Ÿ + hint Ä‘á»ƒ chá»‘ng Ä‘oÃ¡n mÃ².</div>
          <div class="chips">
            <span class="chip">âœ… Offline</span><span class="chip">âœ… Import CSV</span><span class="chip">âœ… BÃ¡o cÃ¡o 7 ngÃ y</span><span class="chip">âœ… PWA</span>
          </div>
        </div>
        <div class="hr"></div>
        <div class="split">
          <div><label class="small muted">Vai trÃ²</label><select id="role"><option value="teacher">GiÃ¡o viÃªn</option><option value="student">Há»c sinh</option><option value="parent">Phá»¥ huynh</option></select></div>
          <div><label class="small muted">MÃ£</label><input id="loginId" placeholder="gv01 hoáº·c hs001" /></div>
        </div>
        <div style="margin-top:10px"><label class="small muted">Máº­t kháº©u</label><input id="loginPw" type="password" placeholder="Demo: 123456" /></div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnLogin">â¡ï¸ VÃ o há»‡ thá»‘ng</button>
          <button class="btn" id="btnQRLogin">ğŸ“· QR</button>
          <button class="btn" id="btnDemo">âœ¨ Táº¡o dá»¯ liá»‡u demo</button>
          <button class="btn" id="btnGuide">ğŸ“Œ HÆ°á»›ng dáº«n náº¡p dá»± Ã¡n</button>
        </div>
        <div class="hr"></div>
        <div id="guideBox" class="notice hidden">
          <div class="title" style="margin-bottom:6px">Checklist â€œNáº¡p dá»± Ã¡nâ€</div>
          <div class="help">
            1) Báº¥m <b>Táº¡o dá»¯ liá»‡u demo</b> â†’ Ä‘Äƒng nháº­p GV: <b>gv01/123456</b>.<br>
            2) Import <b>questionbank_toan9_300.csv</b> + danh sÃ¡ch HS (CSV).<br>
            3) Chá»n HS â†’ báº¥m <b>âš¡ Táº¡o dá»¯ liá»‡u test 7 ngÃ y</b> â†’ <b>Xem bÃ¡o cÃ¡o</b> â†’ <b>In/LÆ°u PDF</b> Ä‘á»ƒ ná»™p minh chá»©ng.<br>
            4) Náº¿u ná»™p dáº¡ng â€œá»©ng dá»¥ngâ€: Chrome â†’ Add to Home screen (hoáº·c báº¥m â€œCÃ i appâ€).<br>
          </div>
        </div>
        <div class="kpi" style="margin-top:12px">
          <div class="box"><div class="num" id="kpiQB">0</div><div class="lab">CÃ¢u há»i</div></div>
          <div class="box"><div class="num" id="kpiStu">0</div><div class="lab">Há»c sinh</div></div>
          <div class="box"><div class="num" id="kpi7">0</div><div class="lab">LÆ°á»£t lÃ m (7 ngÃ y)</div></div>
          <div class="box"><div class="num" id="kpiStreak">0</div><div class="lab">Streak cao nháº¥t</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><div class="title">Giáº£i thÃ­ch â€œAIâ€ cho giÃ¡m kháº£o</div><span class="pill">Pitch 30 giÃ¢y</span></div>
      <div class="bd">
        <div class="help">
          <b>AI chá»n cÃ¢u theo 3 tÃ­n hiá»‡u:</b><br>
          â‘  YÃªu cáº§u tiáº¿ng Viá»‡t â†’ map keyword â†’ chá»§ Ä‘á».<br>
          â‘¡ Lá»— há»•ng (mastery tháº¥p) â†’ Æ°u tiÃªn bÃ¹ láº¥p.<br>
          â‘¢ Äá»™ khÃ³ thÃ­ch nghi (mastery tÄƒng) â†’ nÃ¢ng diff 1â†’2â†’3.<br><br>
          <b>Chá»‘ng Ä‘oÃ¡n mÃ²:</b> sai quÃ¡ nhanh â†’ báº­t <b>Gate</b> (cÃ¢u dá»… + hint báº¯t buá»™c).<br><br>
          <b>Minh chá»©ng:</b> bÃ¡o cÃ¡o 7 ngÃ y theo ngÃ y + streak + chá»§ Ä‘á» yáº¿u.
        </div>
        <div class="hr"></div>
        <div class="help"><b>LÆ°u Ã½ SGK:</b> máº·c Ä‘á»‹nh dÃ¹ng cÃ¢u demo tá»± táº¡o; khÃ´ng sao chÃ©p nguyÃªn vÄƒn SGK.</div>
      </div>
    </div>
  </div>

  <!-- TEACHER -->
  <div class="hidden" id="viewTeacher">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div><div class="title">Báº£ng Ä‘iá»u khiá»ƒn giÃ¡o viÃªn</div><div class="small muted">Import Â· BÃ¡o cÃ¡o Â· In/PDF</div></div>
          <div class="row"><span class="pill" id="pillTeacher"></span><button class="btn" id="btnLogoutT">ğŸšª ÄÄƒng xuáº¥t</button></div>
        </div>
        <div class="bd">
          <div class="row">
            <button class="btn" id="btnImportStudents">ğŸ‘¥ Import HS (CSV)</button>
            <button class="btn" id="btnImportStudentsXLSX">ğŸ“Š Import HS (Excel)</button>
            <button class="btn" id="btnImportQuestions">ğŸ“š Import cÃ¢u há»i (CSV)</button>
            <button class="btn" id="btnImportQuestionsDOCX">ğŸ“ Import cÃ¢u há»i (Word)</button>
            <button class="btn" id="btnExportDB">â¬‡ï¸ Export JSON</button>
            <button class="btn" id="btnAddStudentManual">â• ThÃªm HS</button>
            <button class="btn" id="btnAddTeacherManual">â• ThÃªm GV</button>
          </div>
          <div id="manualStudentBox" class="notice hidden" style="margin-top:10px">
            <div class="row" style="justify-content:space-between">
              <div class="title">ThÃªm há»c sinh thá»§ cÃ´ng</div>
              <span class="pill">Máº­t kháº©u máº·c Ä‘á»‹nh: <b>123456</b></span>
            </div>
            <div class="split" style="margin-top:10px">
              <div>
                <label class="small muted">MÃ£ há»c sinh (ID)</label>
                <input id="mstuId" placeholder="VD: hs010" />
              </div>
              <div>
                <label class="small muted">Há» vÃ  tÃªn</label>
                <input id="mstuName" placeholder="VD: LÃ² Thá»‹ C" />
              </div>
            </div>
            <div class="split" style="margin-top:10px">
              <div>
                <label class="small muted">Lá»›p</label>
                <input id="mstuClass" placeholder="VD: 9A" />
              </div>
              <div>
                <label class="small muted">Máº­t kháº©u (tuá»³ chá»n)</label>
                <input id="mstuPw" placeholder="Äá»ƒ trá»‘ng = 123456" />
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="btnSaveManualStudent">ğŸ’¾ LÆ°u há»c sinh</button>
              <button class="btn" id="btnClearManualStudent">ğŸ§½ XoÃ¡ Ã´ nháº­p</button>
              <span class="help">Nháº­p xong báº¥m â€œLÆ°uâ€ â†’ HS xuáº¥t hiá»‡n trong danh sÃ¡ch.</span>
            </div>
          </div>


          <div id="manualTeacherBox" class="notice hidden" style="margin-top:10px">
            <div class="row" style="justify-content:space-between">
              <div class="title">ThÃªm giÃ¡o viÃªn thá»§ cÃ´ng</div>
              <span class="pill">Máº­t kháº©u máº·c Ä‘á»‹nh: <b>123456</b></span>
            </div>
            <div class="split" style="margin-top:10px">
              <div>
                <label class="small muted">MÃ£ giÃ¡o viÃªn (ID)</label>
                <input id="mtchId" placeholder="VD: gv02" />
              </div>
              <div>
                <label class="small muted">Há» vÃ  tÃªn</label>
                <input id="mtchName" placeholder="VD: CÃ´ Lan" />
              </div>
            </div>
            <div class="split" style="margin-top:10px">
              <div>
                <label class="small muted">Máº­t kháº©u (tuá»³ chá»n)</label>
                <input id="mtchPw" placeholder="Äá»ƒ trá»‘ng = 123456" />
              </div>
              <div>
                <label class="small muted">Ghi chÃº</label>
                <div class="help">GV má»›i cÃ³ thá»ƒ Ä‘Äƒng nháº­p ngay vá»›i vai trÃ² <b>GiÃ¡o viÃªn</b>.</div>
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="btnSaveManualTeacher">ğŸ’¾ LÆ°u giÃ¡o viÃªn</button>
              <button class="btn" id="btnClearManualTeacher">ğŸ§½ XoÃ¡ Ã´ nháº­p</button>
              <span class="help">Nháº­p xong báº¥m â€œLÆ°uâ€ â†’ Ä‘Äƒng nháº­p báº±ng ID/PW.</span>
            </div>
          </div>

          <div id="settingsBoxTeacher" class="notice" style="margin-top:10px">
            <div class="row" style="justify-content:space-between;align-items:flex-start">
              <div>
                <div class="title">CÃ i Ä‘áº·t sá»‘ cÃ¢u há»i má»—i ngÃ y</div>
                <div class="help">GiÃ¡o viÃªn Ä‘áº·t <b>máº·c Ä‘á»‹nh</b>. Há»c sinh váº«n cÃ³ thá»ƒ tá»± chá»n khi lÃ m bÃ i.</div>
              </div>
              <span class="pill">3â€“15 cÃ¢u</span>
            </div>
            <div class="split" style="margin-top:10px">
              <div>
                <label class="small muted">Máº·c Ä‘á»‹nh sá»‘ cÃ¢u / ngÃ y</label>
                <select id="teacherPerDay">
                  <option value="3">3</option>
                  <option value="5">5</option>
                  <option value="7">7</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                </select>
              </div>
              <div>
                <label class="small muted">Gá»£i Ã½</label>
                <div class="help">5â€“7 cÃ¢u Ä‘á»ƒ demo mÆ°á»£t vÃ  cÃ³ Ä‘á»§ dá»¯ liá»‡u AI.</div>
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="btnSaveTeacherPerDay">ğŸ’¾ LÆ°u cÃ i Ä‘áº·t</button>
              <span class="help">LÆ°u offline trong trÃ¬nh duyá»‡t.</span>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnSeed7">âš¡ Táº¡o dá»¯ liá»‡u test 7 ngÃ y</button>
            <button class="btn" id="btnNextDay">â­ï¸ +1 ngÃ y (Test)</button>
            <button class="btn" id="btnResetDay">ğŸ” Reset ngÃ y Test</button>
          </div>
          <div class="hr"></div>
          <div class="split" style="align-items:end">
            <div><label class="small muted">Chá»n há»c sinh</label><select id="teacherStudentSelect"></select></div>
            <div><label class="small muted">Nháº­n xÃ©t</label><input id="teacherComment" placeholder="VD: Tiáº¿n bá»™ há»‡ PT; cáº§n luyá»‡n gÃ³c ná»™i tiáº¿p." /></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnViewReport">ğŸ“Š Xem bÃ¡o cÃ¡o 7 ngÃ y</button>
            <button class="btn" id="btnPrintReport">ğŸ–¨ In / LÆ°u PDF</button>
            <button class="btn" id="btnViewHistoryT">ğŸ—‚ Xem káº¿t quáº£ chi tiáº¿t</button>
          </div>
          <div id="teacherHistory" style="margin-top:10px"></div>
          <div class="hr"></div>
          <div class="split">
            <div><label class="small muted">Lá»c theo chá»§ Ä‘á»</label><select id="filterSkill"></select></div>
            <div><label class="small muted">TÃ¬m theo tá»« khoÃ¡</label><input id="filterText" placeholder="VD: gÃ³c ná»™i tiáº¿p, há»‡ phÆ°Æ¡ng trÃ¬nh..." /></div>
          </div>
          <div class="help" style="margin-top:8px">Xem nhanh giÃºp demo: Ä‘á»§ cÃ¢u dá»…/vá»«a/khÃ³ theo tá»«ng chá»§ Ä‘á».</div>
          <div id="qPreview" style="margin-top:10px"></div>
          <div class="hr"></div>
          <div id="teacherReport"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><div class="title">Máº«u CSV chuáº©n</div><span class="pill">copy</span></div>
        <div class="bd">
          <div class="help"><b>HS CSV:</b></div>
          <pre style="white-space:pre-wrap;border:1px solid var(--bd);border-radius:14px;padding:10px;background:#fbfbfb">id,name,class
hs001,Nguyá»…n VÄƒn A,9A
hs002,LÃ² Thá»‹ B,9A</pre>
          <div class="help"><b>CÃ¢u há»i CSV (header):</b></div>
          <pre style="white-space:pre-wrap;border:1px solid var(--bd);border-radius:14px;padding:10px;background:#fbfbfb">subject,skill,diff,text,A,B,C,D,ans,explain,hint1,hint2,hint3</pre>
          <div class="help">diff: 1=dá»…, 2=vá»«a, 3=khÃ³. ans âˆˆ {A,B,C,D}. skill pháº£i Ä‘Ãºng ID chá»§ Ä‘á».</div>
        </div>
      </div>
    </div>
  </div>

  <!-- STUDENT -->
  <div class="hidden" id="viewStudent">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div><div class="title" id="stuTitle">Há»c sinh</div><div class="small muted">Má»—i ngÃ y <b id="stuPerDayLabel">3</b> cÃ¢u Â· 7 ngÃ y liÃªn tá»¥c</div></div>
          <div class="row"><span class="pill" id="pillStudent"></span><button class="btn" id="btnLogoutS">ğŸšª ÄÄƒng xuáº¥t</button></div>
        </div>
        <div class="bd">
          <div class="row" style="justify-content:space-between">
            <span class="pill">ğŸ”¥ Streak: <b id="stuStreak">0</b></span>
            <span class="pill">âš¡ NÄƒng lÆ°á»£ng: <b id="stuEnergy">0</b></span>
            <span class="pill">ğŸ Äiá»ƒm: <b id="stuScore">0</b></span>
            <span class="pill">ğŸ¯ Lá»— há»•ng: <b id="stuWeak">â€”</b></span>
          </div>
          <div class="hr"></div>
          <label class="small muted">YÃªu cáº§u</label>
          <textarea id="stuReq" placeholder="VD: em muá»‘n luyá»‡n há»‡ phÆ°Æ¡ng trÃ¬nh / gÃ³c ná»™i tiáº¿p / báº­c hai..."></textarea>
          <div class="split" style="margin-top:10px;align-items:end">
            <div>
              <label class="small muted">Sá»‘ cÃ¢u hÃ´m nay</label>
              <select id="studentPerDay">
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="7">7</option>
                <option value="10">10</option>
                <option value="15">15</option>
              </select>
            </div>
            <div class="help">Báº¡n cÃ³ thá»ƒ tÄƒng sá»‘ cÃ¢u Ä‘á»ƒ luyá»‡n nhiá»u hÆ¡n (khuyáº¿n nghá»‹ 5â€“7).</div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnStart">â–¶ï¸ Báº¯t Ä‘áº§u phiÃªn há»c</button>
            <button class="btn" id="btnShowWeek">ğŸ“… BÃ¡o cÃ¡o 7 ngÃ y</button>
            <button class="btn" id="btnGame">ğŸ® TrÃ² chÆ¡i</button>
            <button class="btn" id="btnMyQR">ğŸ”³ QR Ä‘Äƒng nháº­p</button>
            <button class="btn" id="btnResetToday">â™»ï¸ LÃ m láº¡i hÃ´m nay</button>
          </div>
          <div class="hr"></div>
          <div id="quizArea"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><div class="title">TÃ³m táº¯t tuáº§n</div><span class="pill" id="pillToday"></span></div>
        <div class="bd"><div id="weekReportMini" class="help"></div></div>
      </div>
    </div>
  </div>

  <input type="file" id="filePicker" class="hidden" accept=".csv,.txt,.json,.xlsx,.xls,.docx" />

  <!-- PARENT -->
  <div class="hidden" id="viewParent">
    <div class="topbar">
      <div>
        <div class="title" id="parTitle">Phá»¥ huynh</div>
        <div class="sub small muted" id="parSub">GiÃ¡m sÃ¡t tiáº¿n Ä‘á»™ há»c táº­p cá»§a con</div>
      </div>
      <div class="row">
        <button class="btn" id="btnLinkChildQR">â• LiÃªn káº¿t con báº±ng QR</button>
        <button class="btn" id="btnRefreshP">ğŸ”„ LÃ m má»›i</button>
        <button class="btn" id="btnLogoutP">ğŸšª ÄÄƒng xuáº¥t</button>
      </div>
    </div>

    <div class="card">
      <div class="bd">
        <div class="split">
          <div>
            <label class="small muted">Chá»n con</label>
            <select id="selChild"></select>
          </div>
          <div style="display:flex;align-items:flex-end;gap:10px">
            <button class="btn" id="btnShowWeekP">ğŸ“… BÃ¡o cÃ¡o 7 ngÃ y</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="parentArea"></div>
      </div>
    </div>
  </div>

</main>

<div class="toast" id="toast"></div>

<script>
if ("serviceWorker" in navigator) window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js").catch(()=>{}));
let deferredPrompt=null; window.addEventListener("beforeinstallprompt",(e)=>{e.preventDefault();deferredPrompt=e;});
document.getElementById("btnInstall").onclick=async()=>{ if(!deferredPrompt){toast("TrÃ¬nh duyá»‡t chÆ°a há»— trá»£ hoáº·c app Ä‘Ã£ cÃ i.");return;} deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; };

const LS_KEY="MDUN_STREAK_AI_DB_V3_SUBMIT";
const TEST_DAY_OFFSET_KEY="MDUN_TEST_DAY_OFFSET_V3";
const DEFAULT_SKILLS=[{"id": "alg_root", "name": "Äáº¡i sá»‘: CÄƒn thá»©c & biáº¿n Ä‘á»•i"}, {"id": "alg_poly", "name": "Äáº¡i sá»‘: Äa thá»©c & háº±ng Ä‘áº³ng thá»©c"}, {"id": "alg_linear_eq", "name": "Äáº¡i sá»‘: PhÆ°Æ¡ng trÃ¬nh báº­c nháº¥t"}, {"id": "alg_inequality", "name": "Äáº¡i sá»‘: Báº¥t phÆ°Æ¡ng trÃ¬nh"}, {"id": "alg_system", "name": "Äáº¡i sá»‘: Há»‡ phÆ°Æ¡ng trÃ¬nh 2 áº©n"}, {"id": "alg_quadratic", "name": "Äáº¡i sá»‘: PhÆ°Æ¡ng trÃ¬nh báº­c hai"}, {"id": "alg_function_linear", "name": "Äáº¡i sá»‘: HÃ m sá»‘ báº­c nháº¥t & Ä‘á»“ thá»‹"}, {"id": "alg_statistics", "name": "Äáº¡i sá»‘: Thá»‘ng kÃª cÆ¡ báº£n"}, {"id": "geo_pythag", "name": "HÃ¬nh há»c: Äá»‹nh lÃ½ Pythagore"}, {"id": "geo_trig", "name": "HÃ¬nh há»c: Há»‡ thá»©c lÆ°á»£ng (sin/cos/tan)"}, {"id": "geo_similarity", "name": "HÃ¬nh há»c: Tam giÃ¡c Ä‘á»“ng dáº¡ng"}, {"id": "geo_circle_length_area", "name": "HÃ¬nh há»c: ÄÆ°á»ng trÃ²n (chu vi/diá»‡n tÃ­ch)"}, {"id": "geo_circle_angles", "name": "HÃ¬nh há»c: GÃ³c trong Ä‘Æ°á»ng trÃ²n"}, {"id": "geo_circle_tangent", "name": "HÃ¬nh há»c: Tiáº¿p tuyáº¿n & dÃ¢y cung"}, {"id": "geo_coordinate", "name": "HÃ¬nh há»c: Tá»a Ä‘á»™ pháº³ng"}];
const DEFAULT_QUESTIONS=[{"id": "qseed_000", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 1, "text": "RÃºt gá»n: âˆš36", "A": "5", "B": "36", "C": "7", "D": "6", "ans": "D", "explain": "âˆš(kÂ²)=|k|, vá»›i k=6>0 â‡’ 6.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_001", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 1, "text": "RÃºt gá»n: âˆš49", "A": "49", "B": "6", "C": "8", "D": "7", "ans": "D", "explain": "âˆš(kÂ²)=|k|, vá»›i k=7>0 â‡’ 7.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_002", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 1, "text": "RÃºt gá»n: âˆš9", "A": "9", "B": "4", "C": "2", "D": "3", "ans": "D", "explain": "âˆš(kÂ²)=|k|, vá»›i k=3>0 â‡’ 3.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_003", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 1, "text": "RÃºt gá»n: âˆš4", "A": "2", "B": "1", "C": "3", "D": "4", "ans": "A", "explain": "âˆš(kÂ²)=|k|, vá»›i k=2>0 â‡’ 2.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_004", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 1, "text": "RÃºt gá»n: âˆš5184", "A": "5184", "B": "71", "C": "72", "D": "73", "ans": "C", "explain": "âˆš(kÂ²)=|k|, vá»›i k=72>0 â‡’ 72.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_005", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 1, "text": "RÃºt gá»n: âˆš400", "A": "400", "B": "19", "C": "20", "D": "21", "ans": "C", "explain": "âˆš(kÂ²)=|k|, vá»›i k=20>0 â‡’ 20.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_006", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 1, "text": "RÃºt gá»n: âˆš400", "A": "21", "B": "400", "C": "19", "D": "20", "ans": "D", "explain": "âˆš(kÂ²)=|k|, vá»›i k=20>0 â‡’ 20.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_007", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 2, "text": "RÃºt gá»n: âˆš576", "A": "23", "B": "576", "C": "24", "D": "25", "ans": "C", "explain": "âˆš(kÂ²)=|k|, vá»›i k=24>0 â‡’ 24.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_008", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 2, "text": "RÃºt gá»n: âˆš729", "A": "26", "B": "729", "C": "28", "D": "27", "ans": "D", "explain": "âˆš(kÂ²)=|k|, vá»›i k=27>0 â‡’ 27.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_009", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 2, "text": "RÃºt gá»n: âˆš576", "A": "23", "B": "24", "C": "25", "D": "576", "ans": "B", "explain": "âˆš(kÂ²)=|k|, vá»›i k=24>0 â‡’ 24.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_010", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 2, "text": "RÃºt gá»n: âˆš144", "A": "144", "B": "11", "C": "12", "D": "13", "ans": "C", "explain": "âˆš(kÂ²)=|k|, vá»›i k=12>0 â‡’ 12.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_011", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 2, "text": "RÃºt gá»n: âˆš729", "A": "27", "B": "26", "C": "729", "D": "28", "ans": "A", "explain": "âˆš(kÂ²)=|k|, vá»›i k=27>0 â‡’ 27.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_012", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 2, "text": "RÃºt gá»n: âˆš576", "A": "24", "B": "23", "C": "25", "D": "576", "ans": "A", "explain": "âˆš(kÂ²)=|k|, vá»›i k=24>0 â‡’ 24.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_013", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 2, "text": "RÃºt gá»n: âˆš25", "A": "4", "B": "5", "C": "6", "D": "25", "ans": "B", "explain": "âˆš(kÂ²)=|k|, vá»›i k=5>0 â‡’ 5.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_014", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 3, "text": "RÃºt gá»n: âˆš729", "A": "729", "B": "27", "C": "26", "D": "28", "ans": "B", "explain": "âˆš(kÂ²)=|k|, vá»›i k=27>0 â‡’ 27.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_015", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 3, "text": "RÃºt gá»n: âˆš9", "A": "4", "B": "2", "C": "3", "D": "9", "ans": "C", "explain": "âˆš(kÂ²)=|k|, vá»›i k=3>0 â‡’ 3.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_016", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 3, "text": "RÃºt gá»n: âˆš25", "A": "5", "B": "4", "C": "6", "D": "25", "ans": "A", "explain": "âˆš(kÂ²)=|k|, vá»›i k=5>0 â‡’ 5.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_017", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 3, "text": "RÃºt gá»n: âˆš2025", "A": "45", "B": "2025", "C": "46", "D": "44", "ans": "A", "explain": "âˆš(kÂ²)=|k|, vá»›i k=45>0 â‡’ 45.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_018", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 3, "text": "RÃºt gá»n: âˆš49", "A": "7", "B": "6", "C": "8", "D": "49", "ans": "A", "explain": "âˆš(kÂ²)=|k|, vá»›i k=7>0 â‡’ 7.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_019", "subject": "ToÃ¡n 9", "skill": "alg_root", "diff": 3, "text": "RÃºt gá»n: âˆš784", "A": "29", "B": "28", "C": "784", "D": "27", "ans": "B", "explain": "âˆš(kÂ²)=|k|, vá»›i k=28>0 â‡’ 28.", "hint1": "Nhá»›: âˆš(aÂ²)=|a|.", "hint2": "á» Ä‘Ã¢y k>0 nÃªn |k|=k.", "hint3": "Káº¿t luáº­n."}, {"id": "qseed_020", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 1, "text": "Khai triá»ƒn: (4x + 9)Â² báº±ng", "A": "16xÂ² + 36x + 81", "B": "4xÂ² + 72x + 81", "C": "16xÂ² + 72x + 81", "D": "16xÂ² - 72x + 81", "ans": "C", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_021", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 1, "text": "Khai triá»ƒn: (4x + 3)Â² báº±ng", "A": "16xÂ² + 12x + 9", "B": "16xÂ² + 24x + 9", "C": "4xÂ² + 24x + 9", "D": "16xÂ² - 24x + 9", "ans": "B", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_022", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 1, "text": "Khai triá»ƒn: (9x + 9)Â² báº±ng", "A": "81xÂ² + 81x + 81", "B": "81xÂ² + 162x + 81", "C": "81xÂ² - 162x + 81", "D": "9xÂ² + 162x + 81", "ans": "B", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_023", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 1, "text": "Khai triá»ƒn: (3x + 9)Â² báº±ng", "A": "9xÂ² + 54x + 81", "B": "9xÂ² + 27x + 81", "C": "9xÂ² - 54x + 81", "D": "3xÂ² + 54x + 81", "ans": "A", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_024", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 1, "text": "Khai triá»ƒn: (8x + 3)Â² báº±ng", "A": "8xÂ² + 48x + 9", "B": "64xÂ² + 24x + 9", "C": "64xÂ² + 48x + 9", "D": "64xÂ² - 48x + 9", "ans": "C", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_025", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 1, "text": "Khai triá»ƒn: (4x + 9)Â² báº±ng", "A": "16xÂ² - 72x + 81", "B": "16xÂ² + 36x + 81", "C": "4xÂ² + 72x + 81", "D": "16xÂ² + 72x + 81", "ans": "D", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_026", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 1, "text": "Khai triá»ƒn: (5x + 3)Â² báº±ng", "A": "25xÂ² + 15x + 9", "B": "25xÂ² - 30x + 9", "C": "25xÂ² + 30x + 9", "D": "5xÂ² + 30x + 9", "ans": "C", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_027", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 2, "text": "Khai triá»ƒn: (9x + 1)Â² báº±ng", "A": "81xÂ² - 18x + 1", "B": "9xÂ² + 18x + 1", "C": "81xÂ² + 9x + 1", "D": "81xÂ² + 18x + 1", "ans": "D", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_028", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 2, "text": "Khai triá»ƒn: (5x + 2)Â² báº±ng", "A": "25xÂ² - 20x + 4", "B": "25xÂ² + 10x + 4", "C": "5xÂ² + 20x + 4", "D": "25xÂ² + 20x + 4", "ans": "D", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_029", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 2, "text": "Khai triá»ƒn: (4x + 3)Â² báº±ng", "A": "16xÂ² + 12x + 9", "B": "16xÂ² + 24x + 9", "C": "4xÂ² + 24x + 9", "D": "16xÂ² - 24x + 9", "ans": "B", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_030", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 2, "text": "Khai triá»ƒn: (8x + 4)Â² báº±ng", "A": "64xÂ² + 64x + 16", "B": "64xÂ² - 64x + 16", "C": "8xÂ² + 64x + 16", "D": "64xÂ² + 32x + 16", "ans": "A", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_031", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 2, "text": "Khai triá»ƒn: (7x + 8)Â² báº±ng", "A": "49xÂ² + 56x + 64", "B": "7xÂ² + 112x + 64", "C": "49xÂ² + 112x + 64", "D": "49xÂ² - 112x + 64", "ans": "C", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_032", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 2, "text": "Khai triá»ƒn: (7x + 1)Â² báº±ng", "A": "49xÂ² - 14x + 1", "B": "49xÂ² + 14x + 1", "C": "7xÂ² + 14x + 1", "D": "49xÂ² + 7x + 1", "ans": "B", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_033", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 2, "text": "Khai triá»ƒn: (2x + 4)Â² báº±ng", "A": "2xÂ² + 16x + 16", "B": "4xÂ² + 8x + 16", "C": "4xÂ² - 16x + 16", "D": "4xÂ² + 16x + 16", "ans": "D", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_034", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 3, "text": "Khai triá»ƒn: (5x + 5)Â² báº±ng", "A": "25xÂ² + 25x + 25", "B": "5xÂ² + 50x + 25", "C": "25xÂ² + 50x + 25", "D": "25xÂ² - 50x + 25", "ans": "C", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_035", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 3, "text": "Khai triá»ƒn: (9x + 4)Â² báº±ng", "A": "9xÂ² + 72x + 16", "B": "81xÂ² + 72x + 16", "C": "81xÂ² + 36x + 16", "D": "81xÂ² - 72x + 16", "ans": "B", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_036", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 3, "text": "Khai triá»ƒn: (8x + 6)Â² báº±ng", "A": "64xÂ² + 96x + 36", "B": "8xÂ² + 96x + 36", "C": "64xÂ² + 48x + 36", "D": "64xÂ² - 96x + 36", "ans": "A", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_037", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 3, "text": "Khai triá»ƒn: (2x + 2)Â² báº±ng", "A": "4xÂ² - 8x + 4", "B": "2xÂ² + 8x + 4", "C": "4xÂ² + 4x + 4", "D": "4xÂ² + 8x + 4", "ans": "D", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_038", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 3, "text": "Khai triá»ƒn: (3x + 4)Â² báº±ng", "A": "3xÂ² + 24x + 16", "B": "9xÂ² - 24x + 16", "C": "9xÂ² + 24x + 16", "D": "9xÂ² + 12x + 16", "ans": "C", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_039", "subject": "ToÃ¡n 9", "skill": "alg_poly", "diff": 3, "text": "Khai triá»ƒn: (4x + 5)Â² báº±ng", "A": "16xÂ² + 20x + 25", "B": "4xÂ² + 40x + 25", "C": "16xÂ² + 40x + 25", "D": "16xÂ² - 40x + 25", "ans": "C", "explain": "(ax+b)Â² = aÂ²xÂ² + 2abx + bÂ².", "hint1": "DÃ¹ng háº±ng Ä‘áº³ng thá»©c (u+v)Â².", "hint2": "u=ax, v=b.", "hint3": "TÃ­nh 2uv."}, {"id": "qseed_040", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 1, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 3x + (24) = 0", "A": "-7", "B": "-9", "C": "-6", "D": "-8", "ans": "D", "explain": "3x = -24 â‡’ x = -24/3 = -8.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia cáº£ hai váº¿ cho há»‡ sá»‘ cá»§a x.", "hint3": "Kiá»ƒm tra láº¡i báº±ng tháº¿ vÃ o phÆ°Æ¡ng trÃ¬nh."}, {"id": "qseed_041", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 1, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 9x + (-54) = 0", "A": "5", "B": "6", "C": "8", "D": "7", "ans": "B", "explain": "9x = 54 â‡’ x = 54/9 = 6.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia cáº£ hai váº¿ cho há»‡ sá»‘ cá»§a x.", "hint3": "Kiá»ƒm tra láº¡i báº±ng tháº¿ vÃ o phÆ°Æ¡ng trÃ¬nh."}, {"id": "qseed_042", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 1, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 2x + (-6) = 0", "A": "3", "B": "5", "C": "4", "D": "2", "ans": "A", "explain": "2x = 6 â‡’ x = 6/2 = 3.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia cáº£ hai váº¿ cho há»‡ sá»‘ cá»§a x.", "hint3": "Kiá»ƒm tra láº¡i báº±ng tháº¿ vÃ o phÆ°Æ¡ng trÃ¬nh."}, {"id": "qseed_043", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 1, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 9x + (45) = 0", "A": "-6", "B": "-5", "C": "-3", "D": "-4", "ans": "B", "explain": "9x = -45 â‡’ x = -45/9 = -5.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia cáº£ hai váº¿ cho há»‡ sá»‘ cá»§a x.", "hint3": "Kiá»ƒm tra láº¡i báº±ng tháº¿ vÃ o phÆ°Æ¡ng trÃ¬nh."}, {"id": "qseed_044", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 1, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 2x + (-2) = 0", "A": "0", "B": "2", "C": "3", "D": "1", "ans": "D", "explain": "2x = 2 â‡’ x = 2/2 = 1.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia cáº£ hai váº¿ cho há»‡ sá»‘ cá»§a x.", "hint3": "Kiá»ƒm tra láº¡i báº±ng tháº¿ vÃ o phÆ°Æ¡ng trÃ¬nh."}, {"id": "qseed_045", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 1, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 4x + (32) = 0", "A": "-7", "B": "-9", "C": "-6", "D": "-8", "ans": "D", "explain": "4x = -32 â‡’ x = -32/4 = -8.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia cáº£ hai váº¿ cho há»‡ sá»‘ cá»§a x.", "hint3": "Kiá»ƒm tra láº¡i báº±ng tháº¿ vÃ o phÆ°Æ¡ng trÃ¬nh."}, {"id": "qseed_046", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 1, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 5x + (-15) = 0", "A": "4", "B": "5", "C": "2", "D": "3", "ans": "D", "explain": "5x = 15 â‡’ x = 15/5 = 3.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia cáº£ hai váº¿ cho há»‡ sá»‘ cá»§a x.", "hint3": "Kiá»ƒm tra láº¡i báº±ng tháº¿ vÃ o phÆ°Æ¡ng trÃ¬nh."}, {"id": "qseed_047", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 2, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 2x + 9 = -1", "A": "-5", "B": "-4", "C": "-6", "D": "5", "ans": "A", "explain": "2x = -1-9 = -10 â‡’ x = -5.", "hint1": "ÄÆ°a {b} sang váº¿ pháº£i: {a}x = {c}-{b}.", "hint2": "TÃ­nh váº¿ pháº£i.", "hint3": "Chia cho {a}."}, {"id": "qseed_048", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 2, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 5x + 0 = -15", "A": "3", "B": "-3", "C": "-2", "D": "-4", "ans": "B", "explain": "5x = -15-0 = -15 â‡’ x = -3.", "hint1": "ÄÆ°a {b} sang váº¿ pháº£i: {a}x = {c}-{b}.", "hint2": "TÃ­nh váº¿ pháº£i.", "hint3": "Chia cho {a}."}, {"id": "qseed_049", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 2, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 6x + 4 = -2", "A": "-2", "B": "0", "C": "1", "D": "-1", "ans": "D", "explain": "6x = -2-4 = -6 â‡’ x = -1.", "hint1": "ÄÆ°a {b} sang váº¿ pháº£i: {a}x = {c}-{b}.", "hint2": "TÃ­nh váº¿ pháº£i.", "hint3": "Chia cho {a}."}, {"id": "qseed_050", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 2, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 3x + -8 = -2", "A": "2", "B": "-2", "C": "1", "D": "3", "ans": "A", "explain": "3x = -2--8 = 6 â‡’ x = 2.", "hint1": "ÄÆ°a {b} sang váº¿ pháº£i: {a}x = {c}-{b}.", "hint2": "TÃ­nh váº¿ pháº£i.", "hint3": "Chia cho {a}."}, {"id": "qseed_051", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 2, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 7x + -8 = -29", "A": "3", "B": "-3", "C": "-2", "D": "-4", "ans": "B", "explain": "7x = -29--8 = -21 â‡’ x = -3.", "hint1": "ÄÆ°a {b} sang váº¿ pháº£i: {a}x = {c}-{b}.", "hint2": "TÃ­nh váº¿ pháº£i.", "hint3": "Chia cho {a}."}, {"id": "qseed_052", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 2, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 6x + 9 = 45", "A": "-6", "B": "7", "C": "5", "D": "6", "ans": "D", "explain": "6x = 45-9 = 36 â‡’ x = 6.", "hint1": "ÄÆ°a {b} sang váº¿ pháº£i: {a}x = {c}-{b}.", "hint2": "TÃ­nh váº¿ pháº£i.", "hint3": "Chia cho {a}."}, {"id": "qseed_053", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 2, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 3x + -6 = -12", "A": "-1", "B": "-3", "C": "2", "D": "-2", "ans": "D", "explain": "3x = -12--6 = -6 â‡’ x = -2.", "hint1": "ÄÆ°a {b} sang váº¿ pháº£i: {a}x = {c}-{b}.", "hint2": "TÃ­nh váº¿ pháº£i.", "hint3": "Chia cho {a}."}, {"id": "qseed_054", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 3, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 6(x + -2) = 3x + -12", "A": "0", "B": "1", "C": "-1", "D": "-1", "ans": "A", "explain": "Khai triá»ƒn: 6x + -12 = 3x + -12 â‡’ 3x = 0 â‡’ x = 0.", "hint1": "Khai triá»ƒn váº¿ trÃ¡i: a(x+b)=ax+ab.", "hint2": "Chuyá»ƒn cÃ¡c háº¡ng tá»­ chá»©a x vá» má»™t váº¿.", "hint3": "Chia cho há»‡ sá»‘ cá»§a x."}, {"id": "qseed_055", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 3, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 2(x + 5) = 2x + 10", "A": "6", "B": "-6", "C": "5", "D": "4", "ans": "C", "explain": "Khai triá»ƒn: 2x + 10 = 2x + 10 â‡’ 0x = 0 â‡’ x = 5.", "hint1": "Khai triá»ƒn váº¿ trÃ¡i: a(x+b)=ax+ab.", "hint2": "Chuyá»ƒn cÃ¡c háº¡ng tá»­ chá»©a x vá» má»™t váº¿.", "hint3": "Chia cho há»‡ sá»‘ cá»§a x."}, {"id": "qseed_056", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 3, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 3(x + 6) = 4x + 21", "A": "-2", "B": "-3", "C": "-4", "D": "2", "ans": "B", "explain": "Khai triá»ƒn: 3x + 18 = 4x + 21 â‡’ -1x = 3 â‡’ x = -3.", "hint1": "Khai triá»ƒn váº¿ trÃ¡i: a(x+b)=ax+ab.", "hint2": "Chuyá»ƒn cÃ¡c háº¡ng tá»­ chá»©a x vá» má»™t váº¿.", "hint3": "Chia cho há»‡ sá»‘ cá»§a x."}, {"id": "qseed_057", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 3, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 3(x + 3) = 6x + 24", "A": "-6", "B": "-5", "C": "4", "D": "-4", "ans": "B", "explain": "Khai triá»ƒn: 3x + 9 = 6x + 24 â‡’ -3x = 15 â‡’ x = -5.", "hint1": "Khai triá»ƒn váº¿ trÃ¡i: a(x+b)=ax+ab.", "hint2": "Chuyá»ƒn cÃ¡c háº¡ng tá»­ chá»©a x vá» má»™t váº¿.", "hint3": "Chia cho há»‡ sá»‘ cá»§a x."}, {"id": "qseed_058", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 3, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 4(x + -2) = 2x + -8", "A": "-1", "B": "0", "C": "-1", "D": "1", "ans": "B", "explain": "Khai triá»ƒn: 4x + -8 = 2x + -8 â‡’ 2x = 0 â‡’ x = 0.", "hint1": "Khai triá»ƒn váº¿ trÃ¡i: a(x+b)=ax+ab.", "hint2": "Chuyá»ƒn cÃ¡c háº¡ng tá»­ chá»©a x vá» má»™t váº¿.", "hint3": "Chia cho há»‡ sá»‘ cá»§a x."}, {"id": "qseed_059", "subject": "ToÃ¡n 9", "skill": "alg_linear_eq", "diff": 3, "text": "Giáº£i phÆ°Æ¡ng trÃ¬nh: 6(x + -4) = 5x + -20", "A": "-5", "B": "3", "C": "4", "D": "5", "ans": "C", "explain": "Khai triá»ƒn: 6x + -24 = 5x + -20 â‡’ 1x = 4 â‡’ x = 4.", "hint1": "Khai triá»ƒn váº¿ trÃ¡i: a(x+b)=ax+ab.", "hint2": "Chuyá»ƒn cÃ¡c háº¡ng tá»­ chá»©a x vá» má»™t váº¿.", "hint3": "Chia cho há»‡ sá»‘ cá»§a x."}, {"id": "qseed_060", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 1, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 2x + 0 < -6", "A": "x > -3", "B": "x < -3", "C": "x â‰¤ -3", "D": "x â‰¥ -3", "ans": "B", "explain": "2x < -6-0 = -6 â‡’ x < -3.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia hai váº¿ cho sá»‘ dÆ°Æ¡ng thÃ¬ chiá»u khÃ´ng Ä‘á»•i.", "hint3": "Viáº¿t táº­p nghiá»‡m theo dáº¡ng báº¥t Ä‘áº³ng thá»©c."}, {"id": "qseed_061", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 1, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 3x + -9 < -6", "A": "x > 1", "B": "x â‰¤ 1", "C": "x < 1", "D": "x â‰¥ 1", "ans": "C", "explain": "3x < -6--9 = 3 â‡’ x < 1.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia hai váº¿ cho sá»‘ dÆ°Æ¡ng thÃ¬ chiá»u khÃ´ng Ä‘á»•i.", "hint3": "Viáº¿t táº­p nghiá»‡m theo dáº¡ng báº¥t Ä‘áº³ng thá»©c."}, {"id": "qseed_062", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 1, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 9x + -1 < -1", "A": "x â‰¥ 0", "B": "x â‰¤ 0", "C": "x < 0", "D": "x > 0", "ans": "C", "explain": "9x < -1--1 = 0 â‡’ x < 0.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia hai váº¿ cho sá»‘ dÆ°Æ¡ng thÃ¬ chiá»u khÃ´ng Ä‘á»•i.", "hint3": "Viáº¿t táº­p nghiá»‡m theo dáº¡ng báº¥t Ä‘áº³ng thá»©c."}, {"id": "qseed_063", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 1, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 8x + -2 < -2", "A": "x â‰¥ 0", "B": "x â‰¤ 0", "C": "x > 0", "D": "x < 0", "ans": "D", "explain": "8x < -2--2 = 0 â‡’ x < 0.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia hai váº¿ cho sá»‘ dÆ°Æ¡ng thÃ¬ chiá»u khÃ´ng Ä‘á»•i.", "hint3": "Viáº¿t táº­p nghiá»‡m theo dáº¡ng báº¥t Ä‘áº³ng thá»©c."}, {"id": "qseed_064", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 1, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 8x + 7 < 47", "A": "x > 5", "B": "x â‰¥ 5", "C": "x < 5", "D": "x â‰¤ 5", "ans": "C", "explain": "8x < 47-7 = 40 â‡’ x < 5.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia hai váº¿ cho sá»‘ dÆ°Æ¡ng thÃ¬ chiá»u khÃ´ng Ä‘á»•i.", "hint3": "Viáº¿t táº­p nghiá»‡m theo dáº¡ng báº¥t Ä‘áº³ng thá»©c."}, {"id": "qseed_065", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 1, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 6x + 8 < -10", "A": "x > -3", "B": "x â‰¥ -3", "C": "x < -3", "D": "x â‰¤ -3", "ans": "C", "explain": "6x < -10-8 = -18 â‡’ x < -3.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia hai váº¿ cho sá»‘ dÆ°Æ¡ng thÃ¬ chiá»u khÃ´ng Ä‘á»•i.", "hint3": "Viáº¿t táº­p nghiá»‡m theo dáº¡ng báº¥t Ä‘áº³ng thá»©c."}, {"id": "qseed_066", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 1, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 7x + 0 < 42", "A": "x > 6", "B": "x < 6", "C": "x â‰¤ 6", "D": "x â‰¥ 6", "ans": "B", "explain": "7x < 42-0 = 42 â‡’ x < 6.", "hint1": "Chuyá»ƒn háº±ng sá»‘ sang váº¿ pháº£i.", "hint2": "Chia hai váº¿ cho sá»‘ dÆ°Æ¡ng thÃ¬ chiá»u khÃ´ng Ä‘á»•i.", "hint3": "Viáº¿t táº­p nghiá»‡m theo dáº¡ng báº¥t Ä‘áº³ng thá»©c."}, {"id": "qseed_067", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 2, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 5x - -1 â‰¥ -31", "A": "x â‰¤ -6", "B": "x > -6", "C": "x â‰¥ -6", "D": "x < -6", "ans": "C", "explain": "5x â‰¥ -31+-1 = -30 â‡’ x â‰¥ -6.", "hint1": "ÄÆ°a -b sang váº¿ pháº£i: ax â‰¥ c + b.", "hint2": "TÃ­nh c + b.", "hint3": "Chia hai váº¿ cho a > 0."}, {"id": "qseed_068", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 2, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 3x - 1 â‰¥ 10", "A": "x â‰¤ 3", "B": "x â‰¥ 3", "C": "x < 3", "D": "x > 3", "ans": "B", "explain": "3x â‰¥ 10+1 = 9 â‡’ x â‰¥ 3.", "hint1": "ÄÆ°a -b sang váº¿ pháº£i: ax â‰¥ c + b.", "hint2": "TÃ­nh c + b.", "hint3": "Chia hai váº¿ cho a > 0."}, {"id": "qseed_069", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 2, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 6x - 7 â‰¥ -5", "A": "x â‰¥ -2", "B": "x > -2", "C": "x â‰¤ -2", "D": "x < -2", "ans": "A", "explain": "6x â‰¥ -5+7 = -12 â‡’ x â‰¥ -2.", "hint1": "ÄÆ°a -b sang váº¿ pháº£i: ax â‰¥ c + b.", "hint2": "TÃ­nh c + b.", "hint3": "Chia hai váº¿ cho a > 0."}, {"id": "qseed_070", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 2, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 4x - -3 â‰¥ -3", "A": "x â‰¤ 0", "B": "x â‰¥ 0", "C": "x > 0", "D": "x < 0", "ans": "B", "explain": "4x â‰¥ -3+-3 = 0 â‡’ x â‰¥ 0.", "hint1": "ÄÆ°a -b sang váº¿ pháº£i: ax â‰¥ c + b.", "hint2": "TÃ­nh c + b.", "hint3": "Chia hai váº¿ cho a > 0."}, {"id": "qseed_071", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 2, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 6x - 3 â‰¥ 15", "A": "x < 2", "B": "x > 2", "C": "x â‰¤ 2", "D": "x â‰¥ 2", "ans": "D", "explain": "6x â‰¥ 15+3 = 12 â‡’ x â‰¥ 2.", "hint1": "ÄÆ°a -b sang váº¿ pháº£i: ax â‰¥ c + b.", "hint2": "TÃ­nh c + b.", "hint3": "Chia hai váº¿ cho a > 0."}, {"id": "qseed_072", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 2, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 7x - 5 â‰¥ 12", "A": "x â‰¤ 1", "B": "x â‰¥ 1", "C": "x > 1", "D": "x < 1", "ans": "B", "explain": "7x â‰¥ 12+5 = 7 â‡’ x â‰¥ 1.", "hint1": "ÄÆ°a -b sang váº¿ pháº£i: ax â‰¥ c + b.", "hint2": "TÃ­nh c + b.", "hint3": "Chia hai váº¿ cho a > 0."}, {"id": "qseed_073", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 2, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: 4x - -7 â‰¥ -15", "A": "x â‰¤ -2", "B": "x < -2", "C": "x â‰¥ -2", "D": "x > -2", "ans": "C", "explain": "4x â‰¥ -15+-7 = -8 â‡’ x â‰¥ -2.", "hint1": "ÄÆ°a -b sang váº¿ pháº£i: ax â‰¥ c + b.", "hint2": "TÃ­nh c + b.", "hint3": "Chia hai váº¿ cho a > 0."}, {"id": "qseed_074", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 3, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: -3x + -5 > -2", "A": "x > -1", "B": "x â‰¤ -1", "C": "x â‰¥ -1", "D": "x < -1", "ans": "D", "explain": "-3x > -2--5 = 3. Chia cho -3 (<0) nÃªn Ä‘á»•i chiá»u â‡’ x < -1.", "hint1": "Chuyá»ƒn b sang váº¿ pháº£i: ax > c-b.", "hint2": "Nháº­n xÃ©t a < 0 nÃªn khi chia pháº£i Ä‘á»•i chiá»u.", "hint3": "Káº¿t luáº­n nghiá»‡m dáº¡ng x < ..."}, {"id": "qseed_075", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 3, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: -6x + 5 > 23", "A": "x > -3", "B": "x < -3", "C": "x â‰¤ -3", "D": "x â‰¥ -3", "ans": "B", "explain": "-6x > 23-5 = 18. Chia cho -6 (<0) nÃªn Ä‘á»•i chiá»u â‡’ x < -3.", "hint1": "Chuyá»ƒn b sang váº¿ pháº£i: ax > c-b.", "hint2": "Nháº­n xÃ©t a < 0 nÃªn khi chia pháº£i Ä‘á»•i chiá»u.", "hint3": "Káº¿t luáº­n nghiá»‡m dáº¡ng x < ..."}, {"id": "qseed_076", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 3, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: -5x + 3 > -12", "A": "x â‰¥ 3", "B": "x â‰¤ 3", "C": "x < 3", "D": "x > 3", "ans": "C", "explain": "-5x > -12-3 = -15. Chia cho -5 (<0) nÃªn Ä‘á»•i chiá»u â‡’ x < 3.", "hint1": "Chuyá»ƒn b sang váº¿ pháº£i: ax > c-b.", "hint2": "Nháº­n xÃ©t a < 0 nÃªn khi chia pháº£i Ä‘á»•i chiá»u.", "hint3": "Káº¿t luáº­n nghiá»‡m dáº¡ng x < ..."}, {"id": "qseed_077", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 3, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: -2x + -2 > -6", "A": "x < 2", "B": "x â‰¥ 2", "C": "x â‰¤ 2", "D": "x > 2", "ans": "A", "explain": "-2x > -6--2 = -4. Chia cho -2 (<0) nÃªn Ä‘á»•i chiá»u â‡’ x < 2.", "hint1": "Chuyá»ƒn b sang váº¿ pháº£i: ax > c-b.", "hint2": "Nháº­n xÃ©t a < 0 nÃªn khi chia pháº£i Ä‘á»•i chiá»u.", "hint3": "Káº¿t luáº­n nghiá»‡m dáº¡ng x < ..."}, {"id": "qseed_078", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 3, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: -3x + 5 > 14", "A": "x < -3", "B": "x â‰¤ -3", "C": "x â‰¥ -3", "D": "x > -3", "ans": "A", "explain": "-3x > 14-5 = 9. Chia cho -3 (<0) nÃªn Ä‘á»•i chiá»u â‡’ x < -3.", "hint1": "Chuyá»ƒn b sang váº¿ pháº£i: ax > c-b.", "hint2": "Nháº­n xÃ©t a < 0 nÃªn khi chia pháº£i Ä‘á»•i chiá»u.", "hint3": "Káº¿t luáº­n nghiá»‡m dáº¡ng x < ..."}, {"id": "qseed_079", "subject": "ToÃ¡n 9", "skill": "alg_inequality", "diff": 3, "text": "Giáº£i báº¥t phÆ°Æ¡ng trÃ¬nh: -5x + 7 > -18", "A": "x < 5", "B": "x > 5", "C": "x â‰¤ 5", "D": "x â‰¥ 5", "ans": "A", "explain": "-5x > -18-7 = -25. Chia cho -5 (<0) nÃªn Ä‘á»•i chiá»u â‡’ x < 5.", "hint1": "Chuyá»ƒn b sang váº¿ pháº£i: ax > c-b.", "hint2": "Nháº­n xÃ©t a < 0 nÃªn khi chia pháº£i Ä‘á»•i chiá»u.", "hint3": "Káº¿t luáº­n nghiá»‡m dáº¡ng x < ..."}];

function $(id){return document.getElementById(id);}
function toast(msg){const t=$("toast");t.textContent=msg;t.classList.add("show");clearTimeout(toast._tm);toast._tm=setTimeout(()=>t.classList.remove("show"),2400);}

function clampInt(n, lo, hi){n=Number(n); if(!Number.isFinite(n)) n=lo; n=Math.round(n); return Math.max(lo, Math.min(hi, n));}
function ensureSettings(){
  DB.meta = DB.meta || {};
  DB.meta.settings = DB.meta.settings || {};
  if(DB.meta.settings.perDayDefault==null) DB.meta.settings.perDayDefault = 5;
}
function getPerDayForStudent(stu){
  const g = (DB.meta && DB.meta.settings && DB.meta.settings.perDayDefault!=null) ? DB.meta.settings.perDayDefault : 5;
  const s = (stu && stu.settings && stu.settings.perDay!=null) ? stu.settings.perDay : null;
  return clampInt(s ?? g, 3, 15);
}
function setPerDayForStudent(stu, n){
  stu.settings = stu.settings || {};
  stu.settings.perDay = clampInt(n, 3, 15);
}

function fmtDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),da=String(d.getDate()).padStart(2,"0");return y+"-"+m+"-"+da;}
let testDayOffset=Number(localStorage.getItem(TEST_DAY_OFFSET_KEY)||"0");
function nowDate(){const d=new Date();d.setDate(d.getDate()+testDayOffset);return d;}
function todayKey(){return fmtDate(nowDate());}
function setTestOffset(n){testDayOffset=Number(n)||0;localStorage.setItem(TEST_DAY_OFFSET_KEY,String(testDayOffset));toast("Test offset: "+(testDayOffset>=0?"+":"")+testDayOffset+" ngÃ y");refreshAll();}
function nextTestDay(){setTestOffset(testDayOffset+1);} function resetTestOffset(){setTestOffset(0);}

function loadDB(){try{const raw=localStorage.getItem(LS_KEY);if(!raw) return null;return JSON.parse(raw);}catch(e){return null;}}
function saveDB(db){localStorage.setItem(LS_KEY, JSON.stringify(db)); refreshKPIs();}
function newDB(){return {meta:{school:"TrÆ°á»ng PTDTBT THCS MÆ°á»ng Äun",version:"3.0-submission",settings:{perDayDefault:5}},users:{teacher:{"gv01":{id:"gv01",name:"GV Demo",pw:(String(r.pw||"").trim()||"123456")}},student:{},parent:{}},skills:DEFAULT_SKILLS,questions:DEFAULT_QUESTIONS};}
let DB=loadDB()||newDB(); ensureSettings(); saveDB(DB);

function escapeHTML(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
let currentTeacher=null,currentStudentId=null,currentParentId=null,teacherSelected=null,parentChildId=null,session=null;
function SKILL_NAME(){const o={};(DB.skills||[]).forEach(s=>o[s.id]=s.name);return o;}
function ensureSkillId(id){return (DB.skills||[]).some(s=>s.id===id);}

const KEYWORD_TO_SKILLS=[
 {k:["cÄƒn","rÃºt gá»n cÄƒn","cÄƒn báº­c"],ids:["alg_root"]},{k:["háº±ng Ä‘áº³ng","Ä‘a thá»©c","khai triá»ƒn"],ids:["alg_poly"]},
 {k:["phÆ°Æ¡ng trÃ¬nh báº­c nháº¥t","báº­c nháº¥t"],ids:["alg_linear_eq"]},{k:["báº¥t phÆ°Æ¡ng trÃ¬nh","bpt"],ids:["alg_inequality"]},
 {k:["há»‡ phÆ°Æ¡ng trÃ¬nh","há»‡ pt","2 áº©n"],ids:["alg_system"]},{k:["phÆ°Æ¡ng trÃ¬nh báº­c hai","báº­c hai","delta"],ids:["alg_quadratic"]},
 {k:["hÃ m sá»‘ báº­c nháº¥t","Ä‘á»“ thá»‹","y=ax+b"],ids:["alg_function_linear"]},{k:["thá»‘ng kÃª","trung bÃ¬nh","trung vá»‹","má»‘t"],ids:["alg_statistics"]},
 {k:["pitago","pythag","tam giÃ¡c vuÃ´ng"],ids:["geo_pythag"]},{k:["sin","cos","tan","há»‡ thá»©c lÆ°á»£ng"],ids:["geo_trig"]},
 {k:["Ä‘á»“ng dáº¡ng","tá»‰ sá»‘ Ä‘á»“ng dáº¡ng"],ids:["geo_similarity"]},{k:["chu vi","diá»‡n tÃ­ch hÃ¬nh trÃ²n"],ids:["geo_circle_length_area"]},
 {k:["gÃ³c ná»™i tiáº¿p","gÃ³c á»Ÿ tÃ¢m","tá»© giÃ¡c ná»™i tiáº¿p"],ids:["geo_circle_angles"]},{k:["tiáº¿p tuyáº¿n","dÃ¢y cung","lá»±c cá»§a Ä‘iá»ƒm"],ids:["geo_circle_tangent"]},
 {k:["tá»a Ä‘á»™","trung Ä‘iá»ƒm","khoáº£ng cÃ¡ch"],ids:["geo_coordinate"]}
];
function parseRequirement(text){const t=(text||"").toLowerCase();const found=new Set(); for(const r of KEYWORD_TO_SKILLS){if(r.k.some(w=>t.includes(w))) r.ids.forEach(id=>found.add(id));} return [...found].filter(ensureSkillId);}
function getWeakSkills(stu,topN=2){const m=stu.mastery||{};const arr=(DB.skills||[]).map(s=>({id:s.id,val:(m[s.id]??0)}));arr.sort((a,b)=>a.val-b.val);return arr.slice(0,topN).map(x=>x.id);}
function fastThresholdMs(diff){return diff<=1?1500:diff==2?2200:3000;}
function pickQuestionsForToday(stu, reqText, count){
  const reqSkills=new Set(parseRequirement(reqText));
  const weak=getWeakSkills(stu,2); weak.forEach(s=>reqSkills.add(s));
  let targets=[...reqSkills].filter(ensureSkillId); if(targets.length===0) targets=[weak[0] || (DB.skills[0]||{}).id].filter(Boolean);
  const m=stu.mastery||{}; const avg=targets.reduce((s,id)=>s+(m[id]??0),0)/targets.length;
  let baseDiff=1; if(avg>18) baseDiff=3; else if(avg>8) baseDiff=2;
  const pool=(DB.questions||[]).filter(q=>String(q.subject||"").toLowerCase().includes("toÃ¡n") && targets.includes(q.skill));
  const scored=pool.map(q=>{const d=Number(q.diff||1); const diffScore=1.0-Math.min(2,Math.abs(d-baseDiff))*0.35; const mastery=m[q.skill]??0; const weakBoost=1.0+Math.max(0,10-mastery)*0.05; return {q,s:diffScore*weakBoost*(0.9+Math.random()*0.2)};}).sort((a,b)=>b.s-a.s);
  count = clampInt(count ?? 3, 1, 20);
  const chosen=[];
  const used=new Set();
  for(const it of scored){
    if(chosen.length>=count) break;
    if(it && it.q && !used.has(it.q.id)){ chosen.push(it.q); used.add(it.q.id); }
  }
  while(chosen.length<count && pool.length){
    const q = pool[Math.floor(Math.random()*pool.length)];
    if(q && !used.has(q.id)){ chosen.push(q); used.add(q.id); }
    else break;
  }
  const tasks=chosen;
  const explain='AI chá»n theo: yÃªu cáº§u="'+((reqText||"").trim()||"khÃ´ng")+'"; lá»— há»•ng='+weak.map(w=>SKILL_NAME()[w]||w).join(", ")+'; Ä‘á»™ khÃ³ gá»£i Ã½='+baseDiff+'.';
  return {tasks, explain};
}
function pickGateQuestion(skillId, avoidSet){const cand=(DB.questions||[]).filter(q=>q.skill===skillId && Number(q.diff||1)===1 && !avoidSet.has(q.id)); if(!cand.length) return null; return cand[Math.floor(Math.random()*cand.length)];}
function applyAnswerEffects(q,isCorrect,hintLevel,elapsedMs,isGate){
  const diff=Number(q.diff||1); const base=diff===1?6:diff===2?9:12;
  const speedPenalty=Math.max(0,(fastThresholdMs(diff)-elapsedMs)/fastThresholdMs(diff));
  let delta=0; if(isCorrect) delta=base-hintLevel*2; else delta=-Math.max(3,base*0.55)-(speedPenalty>0.15?2:0);
  if(isGate) delta=Math.max(2,Math.round(base*0.5))-hintLevel;
  const gain=isCorrect?(diff===1?1.2:diff===2?1.6:2.0):-(diff===1?0.8:diff===2?1.1:1.4);
  const masteryDelta=isCorrect?(gain-hintLevel*0.4):gain;
  return {delta:Math.round(delta*10)/10, masteryDelta};
}
function dateDiffDays(aStr,bStr){const a=new Date(aStr+"T00:00:00");const b=new Date(bStr+"T00:00:00");return Math.round((b-a)/(1000*60*60*24));}
function updateStreak(stu,dayStr){const st=stu.streak||{current:0,best:0,lastDay:null}; if(!st.lastDay){st.current=1;st.best=Math.max(st.best,1);st.lastDay=dayStr;} else {const d=dateDiffDays(st.lastDay,dayStr); if(d===1){st.current++;st.best=Math.max(st.best,st.current);st.lastDay=dayStr;} else if(d>1){st.current=1;st.best=Math.max(st.best,1);st.lastDay=dayStr;}} stu.streak=st;}
function energyFromStreak(s){return Math.min(100,10+(s||0)*5);}

function parseCSV(text){
  const rows=[]; let i=0, field="", row=[], inQ=false;
  const pushField=()=>{row.push(field);field="";}; const pushRow=()=>{rows.push(row);row=[];};
  while(i<text.length){const c=text[i];
    if(inQ){if(c==='"'){if(text[i+1]==='"'){field+='"';i++;} else inQ=false;} else field+=c;}
    else{if(c==='"') inQ=true; else if(c===',') pushField(); else if(c==='\n'){pushField();pushRow();} else if(c==='\r'){} else field+=c;}
    i++;
  }
  if(field.length||row.length){pushField();pushRow();}
  return rows.filter(r=>r.some(x=>String(x).trim()!==""));
}
function rowsToObjects(rows){if(rows.length<2) return []; const header=rows[0].map(h=>String(h).trim()); const out=[]; for(let i=1;i<rows.length;i++){const obj={}; for(let j=0;j<header.length;j++) obj[header[j]]=rows[i][j]??""; out.push(obj);} return out;}
function downloadText(filename,text){const blob=new Blob([text],{type:"text/plain;charset=utf-8"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url;a.download=filename; document.body.appendChild(a);a.click();a.remove(); URL.revokeObjectURL(url);}

function importStudentsCSV(objs){let add=0,upd=0;
  for(const r of objs){const id=String(r.id||"").trim(); const name=String(r.name||"").trim(); if(!id||!name) continue; const cls=String(r.class||r.lop||"").trim();
    if(!DB.users.student[id]){DB.users.student[id]={id,name,class:cls,pw:"123456",score:0,mastery:{},streak:{current:0,best:0,lastDay:null},history:[],settings:{perDay:DB.meta.settings.perDayDefault ?? 5}}; add++;}
    else{DB.users.student[id].name=name; if(cls) DB.users.student[id].class=cls; upd++;}
  }
  saveDB(DB); toast("Import HS: +"+add+" (cáº­p nháº­t "+upd+")"); renderTeacher();
}
function importQuestionsCSV(objs){let add=0,skip=0;
  for(const r of objs){
    const skill=String(r.skill||"").trim(); const diff=Number(r.diff||1);
    const text=String(r.text||"").trim(); const A=String(r.A||"").trim(); const B=String(r.B||"").trim(); const C=String(r.C||"").trim(); const D=String(r.D||"").trim();
    const ans=String(r.ans||"").trim().toUpperCase();
    if(!text||!A||!B||!C||!D||!"ABCD".includes(ans)||!ensureSkillId(skill)||!(diff>=1&&diff<=3)){skip++; continue;}
    const id="q_"+Math.random().toString(36).slice(2,10);
    DB.questions.push({id,subject:String(r.subject||"ToÃ¡n 9"),skill,diff,text,A,B,C,D,ans,explain:String(r.explain||""),hint1:String(r.hint1||""),hint2:String(r.hint2||""),hint3:String(r.hint3||"")});
    add++;
  }
  saveDB(DB); toast("Import cÃ¢u há»i: +"+add+" (bá» qua "+skip+")"); renderTeacher();
}
function exportDB(){downloadText("mdun_streak_ai_db.json", JSON.stringify(DB,null,2));}

function lastNDays(n){const base=nowDate(); const out=[]; for(let i=n-1;i>=0;i--){const d=new Date(base); d.setDate(base.getDate()-i); out.push(fmtDate(d));} return out;}
function calcWeekly(stu){
  const days=lastNDays(7); const map=new Map((stu.history||[]).map(h=>[h.day,h]));
  let totalDelta=0,totalCorrect=0,totalHints=0,totalGate=0,daysDone=0; const skillAgg={};
  for(const day of days){const h=map.get(day); if(!h) continue; daysDone++; totalDelta+=Number(h.scoreDelta||0); totalCorrect+=Number(h.correctCount||0); totalHints+=Number(h.hintsUsed||0); totalGate+=(h.gateTasks||[]).length;
    const all=[...(h.tasks||[]),...(h.gateTasks||[])];
    for(const a of all){const sid=a.skill; if(!skillAgg[sid]) skillAgg[sid]={attempt:0,correct:0}; skillAgg[sid].attempt++; if(a.correct) skillAgg[sid].correct++;}
  }
  const acc=Object.entries(skillAgg).map(([sid,v])=>({sid,acc:v.correct/Math.max(1,v.attempt)})).sort((a,b)=>a.acc-b.acc);
  return {days,daysDone,totalDelta,totalCorrect,totalHints,totalGate,weakWeek:acc.slice(0,3).map(x=>x.sid)};
}
function renderReportCard(stu){
  const wk=calcWeekly(stu); const map=new Map((stu.history||[]).map(h=>[h.day,h])); const sn=SKILL_NAME();
  const rows=wk.days.map(day=>{const h=map.get(day);
    return "<tr><td>"+day+"</td><td>"+(h?"âœ…":"â€”")+"</td><td class='right'>"+(h?(h.correctCount||0):0)+"</td><td class='right'>"+(h?(h.hintsUsed||0):0)+"</td><td class='right'>"+(h?(h.gateTasks||[]).length:0)+"</td><td class='right'>"+(h?(h.scoreDelta||0):0)+"</td></tr>";
  }).join("");
  const weakList=wk.weakWeek.length?wk.weakWeek.map(sid=>"<li>"+escapeHTML(sn[sid]||sid)+"</li>").join(""):"<li>ChÆ°a Ä‘á»§ dá»¯ liá»‡u</li>";
  const comment=document.getElementById("teacherComment")?document.getElementById("teacherComment").value.trim():"";
  const note=comment?("Nháº­n xÃ©t GV: <b>"+escapeHTML(comment)+"</b>"):"Gá»£i Ã½: thÃªm nháº­n xÃ©t ngáº¯n.";
  return "<div class='qbox' id='reportPrintable'><div class='row' style='justify-content:space-between;align-items:flex-start'><div><div class='title' style='font-size:16px'>BÃ¡o cÃ¡o 7 ngÃ y â€” "+escapeHTML(stu.name)+" "+(stu.class?("("+escapeHTML(stu.class)+")"):"")+"</div><div class='small muted'>TrÆ°á»ng: <b>"+escapeHTML(DB.meta.school||"")+"</b> Â· NgÃ y há»‡ thá»‘ng: <b>"+todayKey()+"</b> (offset "+testDayOffset+")</div></div><div class='pill'>ğŸ”¥ Streak: "+(stu.streak?.current||0)+" Â· Best: "+(stu.streak?.best||0)+"</div></div>"
    +"<div class='hr'></div><table><thead><tr><th>NgÃ y</th><th>LÃ m?</th><th class='right'>ÄÃºng</th><th class='right'>Hint</th><th class='right'>Gate</th><th class='right'>Äiá»ƒm</th></tr></thead><tbody>"+rows+"</tbody></table>"
    +"<div class='hr'></div><div class='row'><span class='pill'>HoÃ n thÃ nh: <b>"+wk.daysDone+"/7</b></span><span class='pill'>Tá»•ng Ä‘Ãºng: <b>"+wk.totalCorrect+"</b></span><span class='pill'>Hint: <b>"+wk.totalHints+"</b></span><span class='pill'>Gate: <b>"+wk.totalGate+"</b></span><span class='pill'>Äiá»ƒm tuáº§n: <b>"+(Math.round(wk.totalDelta*10)/10)+"</b></span></div>"
    +"<div class='hr'></div><div class='split'><div><div class='small muted'><b>Chá»§ Ä‘á» cáº§n cá»§ng cá»‘:</b></div><ul class='small'>"+weakList+"</ul></div><div><div class='small muted'><b>Nháº­n xÃ©t / kiáº¿n nghá»‹:</b></div><div class='help'>"+note+"</div><div class='help' style='margin-top:8px'>Káº¿ hoáº¡ch tuáº§n sau: luyá»‡n 2 chá»§ Ä‘á» yáº¿u + duy trÃ¬ streak 7/7.</div></div></div>"
    +"<div class='hr'></div><div class='help'><b>Ghi chÃº AI:</b> chá»n cÃ¢u theo yÃªu cáº§u + lá»— há»•ng + Ä‘á»™ khÃ³; chá»‘ng Ä‘oÃ¡n mÃ² báº±ng Gate.</div></div>";
}

function renderHistoryCard(stu){
  const sn=SKILL_NAME();
  const hist=(stu.history||[]).slice().sort((a,b)=>String(b.day||"").localeCompare(String(a.day||"")));
  if(!hist.length){
    return "<div class='notice'><div class='title'>Káº¿t quáº£ chi tiáº¿t</div><div class='help'>Há»c sinh chÆ°a cÃ³ dá»¯ liá»‡u lÃ m bÃ i.</div></div>";
  }
  const qMap=new Map((DB.questions||[]).map(q=>[q.id,q]));
  const blocks=hist.map(h=>{
    const tasks=(h.tasks||[]);
    const gates=(h.gateTasks||h.gateAnswers||[]);
    const all=[...tasks,...gates];
    const skillTags=((h.req&&h.req.parsedSkills)||[]).map(sid=>"<span class='pill'>"+escapeHTML(sn[sid]||sid)+"</span>").join(" ");
    const detailRows=all.map(a=>{
      const q=qMap.get(a.qid)||{};
      const ok=a.correct?"âœ…":"âŒ";
      const gate=a.gate?"<span class='pill'>Gate</span>":"";
      const skill=escapeHTML(sn[a.skill]||a.skill||"");
      const text=escapeHTML(q.text||("["+String(a.qid||"")+"]"));
      const t=((a.elapsedMs||0)/1000);
      const delta=(a.delta||0);
      const ansInfo=(!a.correct && q.ans)?(" <span class='pill'>ÄÃ¡p Ã¡n: <b>"+escapeHTML(q.ans)+"</b></span>"):"";
      return "<tr><td class='right'>"+ok+"</td><td>"+gate+"</td><td>"+skill+"</td><td>"+text+ansInfo+"</td><td class='right'>"+t.toFixed(1)+"s</td><td class='right'>"+delta+"</td></tr>";
    }).join("") || "<tr><td colspan='6' class='muted'>KhÃ´ng cÃ³ dá»¯ liá»‡u cÃ¢u há»i.</td></tr>";
    const summaryLeft="<div><b>"+escapeHTML(h.day||"")+"</b> Â· ÄÃºng: <b>"+(h.correctCount||0)+"</b>/"+(tasks.length||0)+" Â· Hint: "+(h.hintsUsed||0)+"</div>"
                     +"<div class='small muted'>"+escapeHTML((h.req&&h.req.text)||"")+"</div>";
    const summaryRight="<span class='pill'>Äiá»ƒm: <b>"+(h.scoreDelta||0)+"</b></span>";
    return "<details class='qbox' style='margin-top:10px'>"
      +"<summary class='row' style='justify-content:space-between;cursor:pointer'>"
      +"<div>"+summaryLeft+"</div><div>"+summaryRight+"</div>"
      +"</summary>"
      +"<div class='hr'></div>"
      +"<div class='help'><b>LÃ½ do AI chá»n:</b> "+escapeHTML(h.explain||"")+"</div>"
      +(skillTags?("<div class='row' style='flex-wrap:wrap;margin-top:8px'>"+skillTags+"</div>"):"")
      +"<div class='hr'></div>"
      +"<table><thead><tr><th class='right'>KQ</th><th></th><th>Ká»¹ nÄƒng</th><th>CÃ¢u há»i</th><th class='right'>TG</th><th class='right'>Äiá»ƒm</th></tr></thead><tbody>"
      +detailRows
      +"</tbody></table>"
      +"</details>";
  }).join("");
  return "<div class='notice'><div class='row' style='justify-content:space-between'>"
    +"<div><div class='title'>Káº¿t quáº£ chi tiáº¿t</div><div class='small muted'>Xem láº¡i tá»«ng ngÃ y vÃ  tá»«ng cÃ¢u há»i</div></div>"
    +"<span class='pill'>Tá»•ng lÆ°á»£t: <b>"+hist.length+"</b></span>"
    +"</div></div>"+blocks;
}

function renderQuestionPreview(){
  const skill=document.getElementById("filterSkill").value||"";
  const kw=(document.getElementById("filterText").value||"").trim().toLowerCase();
  const sn=SKILL_NAME();
  const list=(DB.questions||[]).filter(q=>{
    const okSkill=skill? q.skill===skill : true;
    const okKw=kw? String(q.text||"").toLowerCase().includes(kw):true;
    return okSkill && okKw && String(q.subject||"").toLowerCase().includes("toÃ¡n");
  }).slice(0,6);
  if(!list.length){document.getElementById("qPreview").innerHTML="<div class='help'>ChÆ°a cÃ³ cÃ¢u phÃ¹ há»£p (hoáº·c chÆ°a import).</div>"; return;}
  document.getElementById("qPreview").innerHTML=list.map(q=>`
    <div class="qbox" style="margin-bottom:10px">
      <div class="row" style="justify-content:space-between">
        <span class="tag">${escapeHTML(sn[q.skill]||q.skill)}</span>
        <span class="tag">diff ${q.diff}</span>
      </div>
      <div class="qtext" style="margin-top:8px">${escapeHTML(q.text)}</div>
      <div class="help">ÄÃ¡p Ã¡n: <b>${q.ans}</b> Â· ${escapeHTML(q[q.ans]||"")}</div>
    </div>
  `).join("");
}

function resetToday(stu){const day=todayKey(); stu.history=(stu.history||[]).filter(h=>h.day!==day); saveDB(DB);}
function renderStudentApp(){
  const stu=DB.users.student[currentStudentId]; if(!stu) return;
  document.getElementById("pillToday").textContent="HÃ´m nay: "+todayKey();
  document.getElementById("stuTitle").textContent="Há»c sinh: "+stu.name+(stu.class?(" ("+stu.class+")"):"");
  document.getElementById("pillStudent").textContent=stu.id;
  const per=getPerDayForStudent(stu);
  const lab=document.getElementById("stuPerDayLabel"); if(lab) lab.textContent=String(per);
  const ssel=document.getElementById("studentPerDay"); if(ssel) ssel.value=String(per);

  document.getElementById("stuStreak").textContent=stu.streak?.current||0;
  document.getElementById("stuEnergy").textContent=energyFromStreak(stu.streak?.current||0);
  document.getElementById("stuScore").textContent=Math.round((stu.score||0)*10)/10;
  const weak=getWeakSkills(stu,1)[0]; document.getElementById("stuWeak").textContent=weak?(SKILL_NAME()[weak]||weak):"â€”";
  const wk=calcWeekly(stu);
  const weakWeek=wk.weakWeek.map(sid=>"â€¢ "+(SKILL_NAME()[sid]||sid)).join("<br/>");
  document.getElementById("weekReportMini").innerHTML="<b>7 ngÃ y:</b> "+wk.daysDone+"/7<br/>Äiá»ƒm tuáº§n: <b>"+(Math.round(wk.totalDelta*10)/10)+"</b><br/>Gate: <b>"+wk.totalGate+"</b><div class='hr'></div><b>Cáº§n luyá»‡n:</b><br/>"+(weakWeek||"ChÆ°a Ä‘á»§ dá»¯ liá»‡u.");
  const done=(stu.history||[]).find(h=>h.day===todayKey());
  if(done && !session) document.getElementById("quizArea").innerHTML="<div class='help'>Báº¡n Ä‘Ã£ hoÃ n thÃ nh hÃ´m nay âœ…</div>";
  else if(!session) document.getElementById("quizArea").innerHTML="<div class='help'>Nháº­p yÃªu cáº§u rá»“i báº¥m â€œBáº¯t Ä‘áº§u 5 phÃºtâ€.</div>";
  else renderQuestion();
}
function startSession(){
  const stu=DB.users.student[currentStudentId]; const day=todayKey();
  if((stu.history||[]).some(h=>h.day===day)){toast("Báº¡n Ä‘Ã£ lÃ m hÃ´m nay. Báº¥m lÃ m láº¡i náº¿u muá»‘n.");return;}
  const req=document.getElementById("stuReq").value.trim();
  const perDay=getPerDayForStudent(stu);
  const sel=pickQuestionsForToday(stu, req, perDay);
  session={day, req, explain:sel.explain, tasks:sel.tasks.map(q=>({q,start:Date.now(),hintLevel:0})), gateQueue:[], idx:0, total: sel.tasks.length, answers:[], gateAnswers:[], correctCount:0, hintsUsed:0, scoreDelta:0};
  toast("Báº¯t Ä‘áº§u!"); renderStudentApp();
}
function renderQuestion(){
  const isGate=session.gateQueue.length>0;
  const cur=isGate?session.gateQueue[0]:session.tasks[session.idx];
  const q=cur.q;
  const prog=isGate?"Gá»£i má»Ÿ (Gate)":"CÃ¢u "+(session.idx+1)+"/"+(session.total||session.tasks.length);
  const hintBox=cur.hintLevel>0?("<div class='pill' style='margin-top:10px'>ğŸ’¡ Hint: "+escapeHTML(q["hint"+cur.hintLevel]||"")+"</div>"):"";
  document.getElementById("quizArea").innerHTML="<div class='qbox'><div class='row' style='justify-content:space-between'><div class='pill'>"+prog+"</div><div class='pill'>"+escapeHTML((SKILL_NAME()[q.skill]||q.skill))+" Â· diff "+q.diff+"</div></div>"
    +"<p class='qtext' style='margin-top:10px'>"+escapeHTML(q.text)+"</p>"
    +["A","B","C","D"].map(L=>"<label class='opt'><input type='radio' name='opt' value='"+L+"'><div class='lab'><b>"+L+".</b> "+escapeHTML(q[L])+"</div></label>").join("")
    +"<div class='row' style='margin-top:10px'><button class='btn primary' id='btnSubmit'>âœ… Tráº£ lá»i</button><button class='btn' id='btnHint'>ğŸ’¡ Hint (+)</button><span class='pill'>â± <b id='timer'>0.0s</b></span></div>"
    +hintBox+"<div class='hr'></div><div class='help'><b>LÃ½ do AI chá»n:</b> "+escapeHTML(session.explain)+"</div></div>";
  clearInterval(renderQuestion._tm);
  renderQuestion._tm=setInterval(()=>{const t=(Date.now()-cur.start)/1000; const el=document.getElementById("timer"); if(el) el.textContent=t.toFixed(1)+"s";},100);
  document.getElementById("btnHint").onclick=()=>{if(cur.hintLevel<3){cur.hintLevel++;session.hintsUsed++;toast("ÄÃ£ má»Ÿ hint");renderQuestion();}else toast("ÄÃ£ háº¿t hint");};
  document.getElementById("btnSubmit").onclick=()=>submitAnswer();
}
function submitAnswer(){
  const stu=DB.users.student[currentStudentId];
  const isGate=session.gateQueue.length>0;
  const cur=isGate?session.gateQueue[0]:session.tasks[session.idx];
  const q=cur.q;
  const chosen=(document.querySelector("input[name='opt']:checked")||{}).value;
  if(!chosen){toast("Chá»n 1 Ä‘Ã¡p Ã¡n");return;}
  const elapsedMs=Date.now()-cur.start;
  const isCorrect=(chosen===q.ans);
  const eff=applyAnswerEffects(q,isCorrect,cur.hintLevel,elapsedMs,isGate);
  session.scoreDelta+=eff.delta;
  stu.mastery=stu.mastery||{};
  stu.mastery[q.skill]=(stu.mastery[q.skill]??0)+eff.masteryDelta;
  const obj={qid:q.id,skill:q.skill,diff:q.diff,correct:isCorrect,hints:cur.hintLevel,elapsedMs:Math.round(elapsedMs),delta:eff.delta,gate:isGate};
  (isGate?session.gateAnswers:session.answers).push(obj);
  if(isCorrect && !isGate) session.correctCount++;
  if(!isGate && !isCorrect && elapsedMs<fastThresholdMs(q.diff)){
    const avoid=new Set([q.id,...session.answers.map(a=>a.qid),...session.gateAnswers.map(a=>a.qid)]);
    const gq=pickGateQuestion(q.skill, avoid);
    if(gq){session.gateQueue.unshift({q:gq,start:Date.now(),hintLevel:1});toast("Sai quÃ¡ nhanh â†’ lÃ m Gate!");renderQuestion();return;}
  }
  clearInterval(renderQuestion._tm);
  document.getElementById("quizArea").innerHTML="<div class='qbox'><div class='row' style='justify-content:space-between'><div class='pill'>Káº¿t quáº£</div><div class='pill'>"+escapeHTML((SKILL_NAME()[q.skill]||q.skill))+" Â· diff "+q.diff+"</div></div>"
    +"<div style='margin-top:10px;font-size:18px'>"+(isCorrect?"<span class='good'>âœ… ÄÃºng</span>":"<span class='bad'>âŒ Sai</span>")+" <span class='pill'>Äiá»ƒm <b>"+eff.delta+"</b></span> <span class='pill'>"+(elapsedMs/1000).toFixed(1)+"s</span></div>"
    +"<div class='hr'></div><div class='help'><b>Giáº£i thÃ­ch:</b> "+escapeHTML(q.explain||"")+"</div><div class='help' style='margin-top:8px'><b>ÄÃ¡p Ã¡n:</b> "+q.ans+" Â· <b>"+escapeHTML(q[q.ans]||"")+"</b></div>"
    +"<div class='row' style='margin-top:12px'><button class='btn primary' id='btnNext'>â¡ï¸ Tiáº¿p tá»¥c</button></div></div>";
  document.getElementById("btnNext").onclick=()=>{
    if(isGate){session.gateQueue.shift();} else session.idx++;
    if(session.gateQueue.length){renderQuestion();return;}
    if(session.idx>=session.tasks.length){finishSession();return;}
    session.tasks[session.idx].start=Date.now(); renderQuestion();
  };
}
function finishSession(){
  const stu=DB.users.student[currentStudentId];
  const day=todayKey();
  updateStreak(stu,day);
  stu.score=(stu.score||0)+session.scoreDelta;
  stu.history=stu.history||[];
  stu.history.push({day,req:{text:session.req,parsedSkills:parseRequirement(session.req)},explain:session.explain,tasks:session.answers,gateTasks:session.gateAnswers,correctCount:session.correctCount,hintsUsed:session.hintsUsed,scoreDelta:Math.round(session.scoreDelta*10)/10});
  session=null; saveDB(DB); toast("HoÃ n thÃ nh hÃ´m nay âœ…"); renderStudentApp();
}

function seedDemo(){
  const sample=[{id:"hs001",name:"LÃ² VÄƒn A",class:"9A"},{id:"hs002",name:"LÃ² Thá»‹ B",class:"9A"},{id:"hs003",name:"Nguyá»…n VÄƒn C",class:"9B"}];
  for(const s of sample){if(!DB.users.student[s.id]) DB.users.student[s.id]={id:s.id,name:s.name,class:s.class,pw:"123456",score:0,mastery:{},streak:{current:0,best:0,lastDay:null},history:[],settings:{perDay:DB.meta.settings.perDayDefault ?? 5}};}
  
  // Parent demo (ph01) giÃ¡m sÃ¡t hs001
  if(!DB.users.parent) DB.users.parent={};
  if(!DB.users.parent["ph01"]){DB.users.parent["ph01"]={id:"ph01",name:"PH Demo",pw:"123456",children:["hs001"],createdAt:Date.now()};}
saveDB(DB); toast("ÄÃ£ táº¡o demo.");
}
function seed7DaysForStudent(sid){
  const stu=DB.users.student[sid]; if(!stu) return;
  const base=nowDate(); const days=[]; for(let i=6;i>=0;i--){const d=new Date(base); d.setDate(base.getDate()-i); days.push(fmtDate(d));}
  const existed=new Set((stu.history||[]).map(h=>h.day));
  for(const dayStr of days){
    if(existed.has(dayStr)) continue;
    const req=(Math.random()<0.55)?"luyá»‡n há»‡ phÆ°Æ¡ng trÃ¬nh":(Math.random()<0.5?"gÃ³c ná»™i tiáº¿p":"");
    const perDay=getPerDayForStudent(stu);
    const sel=pickQuestionsForToday(stu,req, perDay);
    let answers=[],gateAnswers=[],correctCount=0,hintsUsed=0,scoreDelta=0;
    for(const q of sel.tasks){
      const willCorrect=Math.random()<0.75;
      const hint=(Math.random()<0.22)?1:0; hintsUsed+=hint;
      const elapsed=willCorrect?(2800+Math.random()*3500):(900+Math.random()*1800);
      const eff=applyAnswerEffects(q,willCorrect,hint,elapsed,false); scoreDelta+=eff.delta;
      stu.mastery[q.skill]=(stu.mastery[q.skill]??0)+eff.masteryDelta;
      answers.push({qid:q.id,skill:q.skill,diff:q.diff,correct:willCorrect,hints:hint,elapsedMs:Math.round(elapsed),delta:eff.delta,gate:false});
      if(willCorrect) correctCount++;
      if(!willCorrect && elapsed<fastThresholdMs(q.diff)){
        const avoid=new Set([q.id,...answers.map(a=>a.qid),...gateAnswers.map(a=>a.qid)]);
        const gq=pickGateQuestion(q.skill,avoid);
        if(gq){
          const geff=applyAnswerEffects(gq,true,1,3200,true); scoreDelta+=geff.delta; hintsUsed+=1;
          gateAnswers.push({qid:gq.id,skill:gq.skill,diff:gq.diff,correct:true,hints:1,elapsedMs:3200,delta:geff.delta,gate:true});
        }
      }
    }
    updateStreak(stu,dayStr);
    stu.score=(stu.score||0)+scoreDelta;
    stu.history.push({day:dayStr,req:{text:req,parsedSkills:parseRequirement(req)},explain:sel.explain,tasks:answers,gateTasks:gateAnswers,correctCount,hintsUsed,scoreDelta:Math.round(scoreDelta*10)/10});
  }
  saveDB(DB);
}

function show(id){document.getElementById("viewLogin").classList.add("hidden");document.getElementById("viewTeacher").classList.add("hidden");document.getElementById("viewStudent").classList.add("hidden");document.getElementById(id).classList.remove("hidden");}
function refreshKPIs(){
  document.getElementById("kpiQB").textContent=(DB.questions||[]).length;
  document.getElementById("kpiStu").textContent=Object.keys(DB.users.student||{}).length;
  let total=0,best=0;
  for(const sid in DB.users.student){const stu=DB.users.student[sid]; total+=calcWeekly(stu).daysDone; best=Math.max(best, stu.streak?.best||0);}
  document.getElementById("kpi7").textContent=total;
  document.getElementById("kpiStreak").textContent=best;
}
function renderTeacher(){
  document.getElementById("pillMode").textContent="Cháº¿ Ä‘á»™: GiÃ¡o viÃªn";
  document.getElementById("pillTeacher").textContent=currentTeacher.id+" Â· "+currentTeacher.name;
  show("viewTeacher");
  refreshPerDayUI();
  const sel=document.getElementById("teacherStudentSelect");
  const stus=Object.values(DB.users.student||{}).sort((a,b)=>a.id.localeCompare(b.id));
  sel.innerHTML=stus.map(s=>"<option value='"+s.id+"'>"+s.id+" â€” "+escapeHTML(s.name)+" "+(s.class?("("+escapeHTML(s.class)+")"):"")+"</option>").join("");
  teacherSelected=sel.value || (stus[0]?.id||null);
  if(teacherSelected) sel.value=teacherSelected;
  sel.onchange=()=>{teacherSelected=sel.value; document.getElementById("teacherReport").innerHTML=""; const th=document.getElementById("teacherHistory"); if(th) th.innerHTML="";};
  const fs=document.getElementById("filterSkill");
  fs.innerHTML="<option value=''>Táº¥t cáº£ chá»§ Ä‘á»</option>"+(DB.skills||[]).map(s=>"<option value='"+s.id+"'>"+escapeHTML(s.name)+" ("+s.id+")</option>").join("");
  fs.onchange=renderQuestionPreview;
  document.getElementById("filterText").oninput=()=>{clearTimeout(renderQuestionPreview._t);renderQuestionPreview._t=setTimeout(renderQuestionPreview,180);};
  renderQuestionPreview();
}
function renderStudent(){document.getElementById("pillMode").textContent="Cháº¿ Ä‘á»™: Há»c sinh"; show("viewStudent"); refreshPerDayUI(); renderStudentApp();}
function refreshAll(){refreshKPIs(); if(currentTeacher) renderTeacher(); if(currentStudentId) renderStudent();}

document.getElementById("btnResetAll").onclick=()=>{ if(confirm("XoÃ¡ toÃ n bá»™ dá»¯ liá»‡u?")){ localStorage.removeItem(LS_KEY); DB=newDB(); saveDB(DB); currentTeacher=null; currentStudentId=null; session=null; teacherSelected=null; document.getElementById("pillMode").textContent="ChÆ°a Ä‘Äƒng nháº­p"; show("viewLogin");
refreshPerDayUI(); toast("ÄÃ£ reset."); } };
document.getElementById("btnGuide").onclick=()=>document.getElementById("guideBox").classList.toggle("hidden");

document.getElementById("btnLogin").onclick=()=>{
  const role=document.getElementById("role").value;
  const id=document.getElementById("loginId").value.trim();
  const pw=document.getElementById("loginPw").value.trim();

  const loginAs=(r,uid)=>{
    if(r==="teacher"){
      currentTeacher=uid; currentStudentId=null; currentParentId=null; session=null; renderTeacher(); return;
    }
    if(r==="parent"){
      currentParentId=uid; currentTeacher=null; currentStudentId=null; session=null; renderParent(); return;
    }
    currentStudentId=uid; currentTeacher=null; currentParentId=null; session=null; renderStudent();
  };

  if(role==="teacher"){
    const u=DB.users.teacher[id];
    if(!u||u.pw!==pw){toast("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u."); return;}
    loginAs("teacher", id); return;
  }
  if(role==="parent"){
    const u=(DB.users.parent||{})[id];
    if(!u||u.pw!==pw){toast("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u."); return;}
    loginAs("parent", id); return;
  }
  const u=DB.users.student[id];
  if(!u||u.pw!==pw){toast("Sai tÃ i khoáº£n hoáº·c máº­t kháº©u."); return;}
  loginAs("student", id);
};
document.getElementById("btnDemo").onclick=()=>{seedDemo(); toast("DÃ¹ng gv01/123456 hoáº·c hs001/123456");};

document.getElementById("btnLogoutT").onclick=()=>{currentTeacher=null; teacherSelected=null; document.getElementById("pillMode").textContent="ChÆ°a Ä‘Äƒng nháº­p"; show("viewLogin"); toast("ÄÃ£ Ä‘Äƒng xuáº¥t");};
document.getElementById("btnLogoutS").onclick=()=>{currentStudentId=null; session=null; document.getElementById("pillMode").textContent="ChÆ°a Ä‘Äƒng nháº­p"; show("viewLogin"); toast("ÄÃ£ Ä‘Äƒng xuáº¥t");};

document.getElementById("btnExportDB").onclick=exportDB;
document.getElementById("btnNextDay").onclick=nextTestDay;
document.getElementById("btnResetDay").onclick=resetTestOffset;
document.getElementById("btnSeed7").onclick=()=>{ if(!teacherSelected) return toast("Chá»n há»c sinh"); seed7DaysForStudent(teacherSelected); toast("ÄÃ£ táº¡o dá»¯ liá»‡u 7 ngÃ y."); };

document.getElementById("btnViewReport").onclick=()=>{ if(!teacherSelected) return toast("Chá»n há»c sinh"); document.getElementById("teacherReport").innerHTML=renderReportCard(DB.users.student[teacherSelected]); };
document.getElementById("btnPrintReport").onclick=()=>{
  const r=document.getElementById("reportPrintable");
  if(!r){toast("HÃ£y báº¥m â€œXem bÃ¡o cÃ¡oâ€ trÆ°á»›c.");return;}
  const win=window.open("","_blank");
  if(!win){toast("TrÃ¬nh duyá»‡t cháº·n pop-up. Cho phÃ©p pop-up Ä‘á»ƒ in/PDF.");return;}
  const css=document.querySelector("style").innerHTML;
  win.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>BÃ¡o cÃ¡o 7 ngÃ y</title><style>${css} body{background:#fff} header{display:none} .wrap{max-width:900px} .card,.qbox{box-shadow:none}</style></head><body><div class="wrap">${r.outerHTML}</div><script>window.onload=()=>{window.print();};<\/script></body></html>`);
  win.document.close();
};

document.getElementById("btnViewHistoryT").onclick=()=>{
  if(!teacherSelected){toast("Chá»n há»c sinh trÆ°á»›c.");return;}
  const stu=DB.users.student[teacherSelected];
  const box=document.getElementById("teacherHistory");
  if(!stu){toast("KhÃ´ng tÃ¬m tháº¥y há»c sinh."); if(box) box.innerHTML=""; return;}
  if(box) box.innerHTML=renderHistoryCard(stu);
};

document.getElementById("btnStart").onclick=startSession;
document.getElementById("btnResetToday").onclick=()=>{ const stu=DB.users.student[currentStudentId]; if(confirm("XoÃ¡ bÃ i lÃ m hÃ´m nay?")){ resetToday(stu); session=null; toast("ÄÃ£ xoÃ¡ hÃ´m nay."); renderStudentApp(); } };
document.getElementById("btnShowWeek").onclick=()=>{ const stu=DB.users.student[currentStudentId]; document.getElementById("quizArea").innerHTML=renderReportCard(stu); };
// ğŸ® Game: má»Ÿ trang trÃ² chÆ¡i (má»Ÿ tab má»›i Ä‘á»ƒ khÃ´ng máº¥t phiÃªn Ä‘Äƒng nháº­p)
document.getElementById("btnGame").onclick=()=>{
  const stu=DB.users.student[currentStudentId];
  try{ localStorage.setItem("qh_player", JSON.stringify({name: (stu?.name||"NgÆ°á»i chÆ¡i").slice(0,18)})); }catch(_){ }
  const url = "./trochoi.html";
  const w = window.open(url, "_blank");
  if(!w) window.location.href = url; // náº¿u trÃ¬nh duyá»‡t cháº·n popup
};

function readAsArrayBuffer(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=()=>rej(fr.error);
    fr.readAsArrayBuffer(file);
  });
}
function openFile(kind){
  const fp=document.getElementById("filePicker");
  fp.value="";
  // set accept by kind
  if(kind==="students") fp.accept=".csv,.txt";
  else if(kind==="questions") fp.accept=".csv,.txt";
  else if(kind==="students_xlsx") fp.accept=".xlsx,.xls";
  else if(kind==="questions_docx") fp.accept=".docx";
  else fp.accept=".csv,.txt,.json,.xlsx,.xls,.docx";

  fp.onchange=async ev=>{
    const file=ev.target.files[0]; if(!file) return;

    // CSV (students/questions)
    if(kind==="students" || kind==="questions"){
      const text=(await file.text()).replace(/^\uFEFF/,"");
      const objs=rowsToObjects(parseCSV(text));
      if(kind==="students") importStudentsCSV(objs);
      if(kind==="questions") importQuestionsCSV(objs);
      return;
    }

    // Excel (students)
    if(kind==="students_xlsx"){
      if(typeof XLSX==="undefined"){ toast("Thiáº¿u thÆ° viá»‡n XLSX. HÃ£y má»Ÿ láº¡i khi cÃ³ máº¡ng 1 láº§n Ä‘á»ƒ táº£i thÆ° viá»‡n."); return; }
      const buf=await readAsArrayBuffer(file);
      const wb=XLSX.read(buf,{type:"array"});
      const sn=wb.SheetNames[0];
      const sheet=wb.Sheets[sn];
      const rows=XLSX.utils.sheet_to_json(sheet,{defval:""});
      // cháº¥p nháº­n nhiá»u tÃªn cá»™t: id / ID / ma / mÃ£, name / há» vÃ  tÃªn, class / lá»›p, pw / máº­t kháº©u
      const objs=rows.map(r=>({
        id: r.id||r.ID||r.Id||r.ma||r["mÃ£"]||r["MÃ£"]||r["MÃ£ HS"]||r["ma_hs"]||"",
        name: r.name||r["Há» vÃ  tÃªn"]||r["Há» tÃªn"]||r["TÃªn"]||r["hoten"]||"",
        class: r.class||r.lop||r["Lá»›p"]||r["lop"]||"",
        pw: r.pw||r["Máº­t kháº©u"]||r["matkhau"]||""
      }));
      importStudentsCSV(objs);
      return;
    }

    // Word DOCX (questions)
    if(kind==="questions_docx"){
      if(typeof mammoth==="undefined"){ toast("Thiáº¿u thÆ° viá»‡n Mammoth (DOCX). HÃ£y má»Ÿ láº¡i khi cÃ³ máº¡ng 1 láº§n Ä‘á»ƒ táº£i thÆ° viá»‡n."); return; }
      const buf=await readAsArrayBuffer(file);
      const result=await mammoth.extractRawText({arrayBuffer:buf});
      const text=(result.value||"").replace(/\r/g,"");
      const objs=parseQuestionsFromDOCX(text);
      if(!objs.length){ toast("KhÃ´ng Ä‘á»c Ä‘Æ°á»£c cÃ¢u há»i tá»« Word. HÃ£y dÃ¹ng Ä‘Ãºng máº«u Word (xem hÆ°á»›ng dáº«n trong README)."); return; }
      importQuestionsCSV(objs);
      return;
    }
  };
  fp.click();
}

// ====== Import Word (DOCX) â†’ objects giá»‘ng CSV ======
function parseQuestionsFromDOCX(raw){
  const text=String(raw||"").replace(/\uFEFF/g,"").trim();
  if(!text) return [];
  // TÃ¡ch theo "CÃ¢u 1", "CÃ¢u 2", "Q1"...
  const blocks=[];
  const rx=/^(?:\s*(?:CÃ¢u|CAU|Q)\s*\d+\s*[:\.\-]?\s*)([\s\S]*?)(?=^\s*(?:CÃ¢u|CAU|Q)\s*\d+\s*[:\.\-]?\s*|\s*$)/gmi;
  let m;
  while((m=rx.exec(text))!==null){
    const body=(m[1]||"").trim();
    if(body) blocks.push(body);
  }
  // Náº¿u khÃ´ng cÃ³ "CÃ¢u 1" thÃ¬ tÃ¡ch theo 2 dÃ²ng trá»‘ng
  if(!blocks.length){
    text.split(/\n\s*\n\s*\n+/).forEach(b=>{b=b.trim(); if(b) blocks.push(b);});
  }

  const out=[];
  for(const b of blocks){
    const lines=b.split("\n").map(x=>x.trim()).filter(x=>x.length);
    if(!lines.length) continue;

    let subject="ToÃ¡n 9";
    let skill="";
    let diff=1;
    let ans="";
    let qText=[];
    let explain="";
    let hint1="",hint2="",hint3="";
    const opts={A:"",B:"",C:"",D:""};
    let mode="q";
    let curOpt="";

    function flushLineToCurrentOption(line){
      if(curOpt){
        opts[curOpt]=(opts[curOpt] ? (opts[curOpt]+" "+line) : line);
        return true;
      }
      return false;
    }

    for(let i=0;i<lines.length;i++){
      const line=lines[i];

      // meta lines
      let mm;
      if((mm=line.match(/^(?:mÃ´n|mon|subject)\s*[:=]\s*(.+)$/i))){ subject=mm[1].trim()||subject; continue; }
      if((mm=line.match(/^(?:skill|chá»§\s*Ä‘á»|chu\s*de|ma\s*chu\s*de)\s*[:=]\s*([a-z0-9_ -]+)$/i))){ skill=mm[1].trim().replace(/\s+/g,"_"); continue; }
      if((mm=line.match(/^(?:Ä‘á»™\s*khÃ³|do\s*kho|diff|level)\s*[:=]\s*([123])$/i))){ diff=Number(mm[1]); continue; }
      if((mm=line.match(/^(?:Ä‘Ã¡p\s*Ã¡n|dap\s*an|ans)\s*[:=]\s*([ABCD])$/i))){ ans=mm[1].toUpperCase(); continue; }

      if((mm=line.match(/^hint\s*1\s*[:=]\s*(.+)$/i))){ hint1=mm[1].trim(); continue; }
      if((mm=line.match(/^hint\s*2\s*[:=]\s*(.+)$/i))){ hint2=mm[1].trim(); continue; }
      if((mm=line.match(/^hint\s*3\s*[:=]\s*(.+)$/i))){ hint3=mm[1].trim(); continue; }

      if((mm=line.match(/^(?:giáº£i\s*thÃ­ch|giai\s*thich|explain)\s*[:=]\s*(.*)$/i))){
        mode="explain";
        explain=mm[1].trim();
        curOpt="";
        continue;
      }

      // option lines A/B/C/D
      if((mm=line.match(/^([ABCD])\s*[\)\.\:\-]\s*(.+)$/i))){
        curOpt=mm[1].toUpperCase();
        opts[curOpt]=mm[2].trim();
        mode="opt";
        continue;
      }

      // append to explain if mode explain
      if(mode==="explain"){
        // stop explain if encountering another meta/option; but we already handled meta/option above.
        explain = explain ? (explain+" "+line) : line;
        continue;
      }

      // if currently in an option, allow wrapped lines
      if(mode==="opt" && flushLineToCurrentOption(line)){
        continue;
      }

      // otherwise treat as question text
      qText.push(line);
    }

    const textQ=qText.join(" ").replace(/\s+/g," ").trim();
    // Try infer skill from inline tags like [skill=alg_system]
    if(!skill){
      const tag=(b.match(/\[skill\s*=\s*([a-z0-9_]+)\]/i)||[])[1];
      if(tag) skill=tag.trim();
    }
    // Try infer diff from tag
    if(!diff || !(diff>=1&&diff<=3)){
      const dtag=(b.match(/\[diff\s*=\s*([123])\]/i)||[])[1];
      if(dtag) diff=Number(dtag);
      else diff=1;
    }
    if(!ans){
      const atag=(b.match(/\[ans\s*=\s*([ABCD])\]/i)||[])[1];
      if(atag) ans=atag.toUpperCase();
    }

    out.push({subject,skill,diff,text:textQ,A:opts.A,B:opts.B,C:opts.C,D:opts.D,ans,explain,hint1,hint2,hint3});
  }
  // lá»c nhá»¯ng block Ä‘á»§ tá»‘i thiá»ƒu
  return out.filter(o=>o.text && o.A && o.B && o.C && o.D);
}
document.getElementById("btnImportStudents").onclick=()=>openFile("students");
document.getElementById("btnImportQuestions").onclick=()=>openFile("questions");
document.getElementById("btnImportStudentsXLSX").onclick=()=>openFile("students_xlsx");
document.getElementById("btnImportQuestionsDOCX").onclick=()=>openFile("questions_docx");


// ====== CÃ i Ä‘áº·t sá»‘ cÃ¢u / ngÃ y ======
function refreshPerDayUI(){
  ensureSettings();
  if(document.getElementById("teacherPerDay")){
    document.getElementById("teacherPerDay").value = String(clampInt(DB.meta.settings.perDayDefault ?? 5, 3, 15));
  }
  if(currentStudentId){
    const stu=DB.users.student[currentStudentId];
    const per=getPerDayForStudent(stu);
    const sel=document.getElementById("studentPerDay");
    if(sel) sel.value=String(per);
    const lab=document.getElementById("stuPerDayLabel");
    if(lab) lab.textContent=String(per);
  }
}
if(document.getElementById("btnSaveTeacherPerDay")){
  document.getElementById("btnSaveTeacherPerDay").onclick=()=>{
    ensureSettings();
    DB.meta.settings.perDayDefault = clampInt(document.getElementById("teacherPerDay").value, 3, 15);
    saveDB(DB);
    toast("ÄÃ£ lÆ°u máº·c Ä‘á»‹nh: "+DB.meta.settings.perDayDefault+" cÃ¢u/ngÃ y");
    refreshPerDayUI();
  };
}
if(document.getElementById("studentPerDay")){
  document.getElementById("studentPerDay").onchange=()=>{
    const stu=DB.users.student[currentStudentId];
    if(!stu) return;
    setPerDayForStudent(stu, document.getElementById("studentPerDay").value);
    saveDB(DB);
    toast("ÄÃ£ chá»n: "+getPerDayForStudent(stu)+" cÃ¢u hÃ´m nay");
    refreshPerDayUI();
  };
}

// ====== ThÃªm há»c sinh thá»§ cÃ´ng ======
if(document.getElementById("btnAddStudentManual")){
  document.getElementById("btnAddStudentManual").onclick=()=>{
    const box=document.getElementById("manualStudentBox");
    box.classList.toggle("hidden");
    if(!box.classList.contains("hidden")) document.getElementById("mstuId").focus();
  };
}
function addStudentManual(){
  const id=document.getElementById("mstuId").value.trim();
  const name=document.getElementById("mstuName").value.trim();
  const cls=document.getElementById("mstuClass").value.trim();
  const pw=(document.getElementById("mstuPw").value.trim() || "123456");
  if(!id || !name){ toast("Thiáº¿u ID hoáº·c há» tÃªn"); return; }
  if(!/^[a-zA-Z0-9_-]{2,20}$/.test(id)){ toast("ID chá»‰ gá»“m chá»¯/sá»‘/_/- (2â€“20 kÃ½ tá»±)"); return; }
  DB.users.student = DB.users.student || {};
  if(DB.users.student[id]){ toast("ID Ä‘Ã£ tá»“n táº¡i."); return; }
  DB.users.student[id]={id,name,class:cls,pw,score:0,mastery:{},streak:{current:0,best:0,lastDay:null},history:[],settings:{perDay:DB.meta.settings.perDayDefault ?? 5}};
  saveDB(DB);
  toast("ÄÃ£ thÃªm há»c sinh: "+id);
  if(currentTeacher) renderTeacher();
  document.getElementById("mstuId").value="";
  document.getElementById("mstuName").value="";
  document.getElementById("mstuClass").value="";
  document.getElementById("mstuPw").value="";
  document.getElementById("mstuId").focus();
}
if(document.getElementById("btnSaveManualStudent")) document.getElementById("btnSaveManualStudent").onclick=addStudentManual;
if(document.getElementById("btnClearManualStudent")) document.getElementById("btnClearManualStudent").onclick=()=>{
  document.getElementById("mstuId").value="";
  document.getElementById("mstuName").value="";
  document.getElementById("mstuClass").value="";
  document.getElementById("mstuPw").value="";
  toast("ÄÃ£ xoÃ¡ Ã´ nháº­p");
  document.getElementById("mstuId").focus();
};


// ====== ThÃªm giÃ¡o viÃªn thá»§ cÃ´ng ======
if(document.getElementById("btnAddTeacherManual")){
  document.getElementById("btnAddTeacherManual").onclick=()=>{
    const box=document.getElementById("manualTeacherBox");
    box.classList.toggle("hidden");
    if(!box.classList.contains("hidden")) document.getElementById("mtchId").focus();
  };
}
function addTeacherManual(){
  const id=document.getElementById("mtchId").value.trim();
  const name=document.getElementById("mtchName").value.trim();
  const pw=(document.getElementById("mtchPw").value.trim() || "123456");
  if(!id || !name){ toast("Thiáº¿u ID hoáº·c há» tÃªn"); return; }
  if(!/^[a-zA-Z0-9_-]{2,20}$/.test(id)){ toast("ID chá»‰ gá»“m chá»¯/sá»‘/_/- (2â€“20 kÃ½ tá»±)"); return; }

  DB.users = DB.users || {};
  DB.users.teacher = DB.users.teacher || {};
  if(DB.users.teacher[id]){ toast("ID giÃ¡o viÃªn Ä‘Ã£ tá»“n táº¡i."); return; }

  DB.users.teacher[id]={id,name,pw};
  saveDB(DB);
  toast("ÄÃ£ thÃªm giÃ¡o viÃªn: "+id);

  // Clear inputs
  document.getElementById("mtchId").value="";
  document.getElementById("mtchName").value="";
  document.getElementById("mtchPw").value="";
  document.getElementById("mtchId").focus();
}
if(document.getElementById("btnSaveManualTeacher")) document.getElementById("btnSaveManualTeacher").onclick=addTeacherManual;
if(document.getElementById("btnClearManualTeacher")) document.getElementById("btnClearManualTeacher").onclick=()=>{
  document.getElementById("mtchId").value="";
  document.getElementById("mtchName").value="";
  document.getElementById("mtchPw").value="";
  toast("ÄÃ£ xoÃ¡ Ã´ nháº­p");
  document.getElementById("mtchId").focus();
};


refreshKPIs();
show("viewLogin");


/* ===========================
   QR Login + Parent Monitoring
   =========================== */
function _randKey(len=16){
  try{
    const a=new Uint8Array(len);
    crypto.getRandomValues(a);
    return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("").slice(0,len);
  }catch(e){
    return Math.random().toString(16).slice(2,2+len)+Math.random().toString(16).slice(2,2+len);
  }
}
function ensureQrSchema(){
  if(!DB.users.parent) DB.users.parent={};
  for(const [id,u] of Object.entries(DB.users.student||{})){
    if(!u.qrKey) u.qrKey=_randKey(24);
  }
  for(const [id,u] of Object.entries(DB.users.teacher||{})){
    if(!u.qrKey) u.qrKey=_randKey(24); // dá»± phÃ²ng (chÆ°a dÃ¹ng)
  }
  for(const [id,u] of Object.entries(DB.users.parent||{})){
    if(!u.qrKey) u.qrKey=_randKey(24);
    if(!Array.isArray(u.children)) u.children=[];
  }
  saveDB(DB);
}
ensureQrSchema();

function makeQRPayload(role,id,key){
  // Format: SCQR|v1|role|id|key
  return ["SCQR","v1",role,String(id||""),String(key||"")].join("|");
}
function parseQRPayload(txt){
  const t=String(txt||"").trim();
  if(!t.startsWith("SCQR|")) return null;
  const parts=t.split("|");
  if(parts.length<5) return null;
  if(parts[1]!=="v1") return null;
  return {role:parts[2], id:parts[3], key:parts[4]};
}

function loginByQR(role,id,key){
  const loginAs=(r,uid)=>{
    if(r==="teacher"){ currentTeacher=uid; currentStudentId=null; currentParentId=null; session=null; renderTeacher(); return true; }
    if(r==="parent"){ currentParentId=uid; currentTeacher=null; currentStudentId=null; session=null; renderParent(); return true; }
    currentStudentId=uid; currentTeacher=null; currentParentId=null; session=null; renderStudent(); return true;
  };

  if(role==="student"){
    const u=(DB.users.student||{})[id];
    if(!u || u.qrKey!==key){ toast("QR khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ Ä‘á»•i."); return false; }
    loginAs("student", id); return true;
  }
  if(role==="parent"){
    const u=(DB.users.parent||{})[id];
    if(!u || u.qrKey!==key){ toast("QR khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ Ä‘á»•i."); return false; }
    loginAs("parent", id); return true;
  }
  toast("Vai trÃ² QR chÆ°a há»— trá»£."); 
  return false;
}

/* ----- QR Modal (scan) ----- */
let _qrScanner=null;
let _qrMode="login"; // 'login' | 'link-child'

function openQRModal(mode="login"){
  _qrMode=mode;
  const modal=document.getElementById("qrModal");
  const title=document.getElementById("qrTitle");
  const hint=document.getElementById("qrHint");
  title.textContent = (mode==="login") ? "ÄÄƒng nháº­p báº±ng QR" : "QuÃ©t QR cá»§a con Ä‘á»ƒ liÃªn káº¿t";
  hint.textContent  = (mode==="login") ? "Cho phÃ©p camera, Ä‘Æ°a QR vÃ o khung." : "Phá»¥ huynh: quÃ©t QR Ä‘Äƒng nháº­p cá»§a há»c sinh.";
  modal.classList.remove("hidden");
  modal.setAttribute("aria-hidden","false");

  // init scanner
  try{
    if(!_qrScanner) _qrScanner=new Html5Qrcode("qrReader");
    _qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 240, height: 240 } },
      (decodedText)=>{
        const p=parseQRPayload(decodedText);
        if(!p){ toast("QR khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng."); return; }
        if(_qrMode==="login"){
          const ok=loginByQR(p.role,p.id,p.key);
          if(ok){ closeQRModal(); }
          return;
        }
        // link-child mode
        if(p.role!=="student"){ toast("HÃ£y quÃ©t QR cá»§a Há»c sinh."); return; }
        const stu=(DB.users.student||{})[p.id];
        if(!stu || stu.qrKey!==p.key){ toast("QR há»c sinh khÃ´ng há»£p lá»‡."); return; }
        const par=(DB.users.parent||{})[currentParentId];
        if(!par){ toast("ChÆ°a Ä‘Äƒng nháº­p phá»¥ huynh."); return; }
        if(!par.children.includes(p.id)) par.children.push(p.id);
        saveDB(DB);
        toast("ÄÃ£ liÃªn káº¿t: "+(stu.name||p.id));
        renderParentApp();
        closeQRModal();
      },
      ()=>{}
    ).catch(()=>{ /* náº¿u lá»—i camera sáº½ váº«n cho chá»n áº£nh */ });
  }catch(e){
    // ignore
  }
}
async function closeQRModal(){
  const modal=document.getElementById("qrModal");
  modal.classList.add("hidden");
  modal.setAttribute("aria-hidden","true");
  try{ if(_qrScanner){ await _qrScanner.stop(); await _qrScanner.clear(); } }catch(e){}
}

document.getElementById("btnQRLogin").onclick=()=>openQRModal("login");
document.getElementById("btnCloseQR").onclick=closeQRModal;
document.getElementById("qrModal").addEventListener("click",(e)=>{ if(e.target.id==="qrModal") closeQRModal(); });

document.getElementById("btnQRFromImage").onclick=()=>document.getElementById("qrImageInput").click();
document.getElementById("qrImageInput").addEventListener("change", async (ev)=>{
  const f=ev.target.files && ev.target.files[0];
  if(!f) return;
  try{
    if(!_qrScanner) _qrScanner=new Html5Qrcode("qrReader");
    const res=await _qrScanner.scanFile(f,true);
    const p=parseQRPayload(res);
    if(!p){ toast("QR khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng."); return; }
    if(_qrMode==="login"){
      const ok=loginByQR(p.role,p.id,p.key);
      if(ok) closeQRModal();
    }else{
      if(p.role!=="student"){ toast("HÃ£y chá»n áº£nh QR cá»§a Há»c sinh."); return; }
      const stu=(DB.users.student||{})[p.id];
      if(!stu || stu.qrKey!==p.key){ toast("QR há»c sinh khÃ´ng há»£p lá»‡."); return; }
      const par=(DB.users.parent||{})[currentParentId];
      if(!par){ toast("ChÆ°a Ä‘Äƒng nháº­p phá»¥ huynh."); return; }
      if(!par.children.includes(p.id)) par.children.push(p.id);
      saveDB(DB); toast("ÄÃ£ liÃªn káº¿t: "+(stu.name||p.id)); renderParentApp(); closeQRModal();
    }
  }catch(e){
    toast("KhÃ´ng Ä‘á»c Ä‘Æ°á»£c QR tá»« áº£nh.");
  }finally{
    ev.target.value="";
  }
});

/* ----- Student: show my QR ----- */
function openMyQR(role,id){
  const modal=document.getElementById("myQRModal");
  const box=document.getElementById("myQRCode");
  const txt=document.getElementById("myQRText");
  box.innerHTML="";
  ensureQrSchema();
  let key="";
  if(role==="student"){ key=(DB.users.student||{})[id]?.qrKey||""; }
  if(role==="parent"){ key=(DB.users.parent||{})[id]?.qrKey||""; }
  const payload=makeQRPayload(role,id,key);
  txt.textContent=payload;
  try{
    new QRCode(box,{text:payload,width:220,height:220});
  }catch(e){
    box.innerHTML='<div class="notice">KhÃ´ng táº¡o Ä‘Æ°á»£c QR trÃªn thiáº¿t bá»‹ nÃ y.</div>';
  }
  modal.classList.remove("hidden");
  modal.setAttribute("aria-hidden","false");
}
function closeMyQR(){
  const modal=document.getElementById("myQRModal");
  modal.classList.add("hidden");
  modal.setAttribute("aria-hidden","true");
}
document.getElementById("btnMyQR").onclick=()=>{ if(currentStudentId) openMyQR("student", currentStudentId); };
document.getElementById("btnCloseMyQR").onclick=closeMyQR;
document.getElementById("myQRModal").addEventListener("click",(e)=>{ if(e.target.id==="myQRModal") closeMyQR(); });

/* ----- Parent view ----- */
function renderParent(){
  document.getElementById("pillMode").textContent="Cháº¿ Ä‘á»™: Phá»¥ huynh";
  show("viewParent");
  renderParentApp();
}
function renderParentApp(){
  const p=(DB.users.parent||{})[currentParentId];
  if(!p){ show("viewLogin"); toast("Háº¿t phiÃªn Ä‘Äƒng nháº­p."); return; }
  document.getElementById("parTitle").textContent = "Phá»¥ huynh: "+(p.name||p.id||"");
  const sel=document.getElementById("selChild");
  const children=p.children||[];
  // náº¿u chÆ°a cÃ³ con, gá»£i Ã½ quÃ©t QR
  if(children.length===0){
    sel.innerHTML='<option value="">(ChÆ°a liÃªn káº¿t)</option>';
    document.getElementById("parentArea").innerHTML=
      '<div class="notice"><b>ChÆ°a cÃ³ há»c sinh liÃªn káº¿t.</b><br>HÃ£y báº¥m <b>â• LiÃªn káº¿t con báº±ng QR</b> rá»“i quÃ©t QR Ä‘Äƒng nháº­p cá»§a há»c sinh.</div>';
    return;
  }
  // set default child
  if(!parentChildId || !children.includes(parentChildId)) parentChildId=children[0];
  sel.innerHTML=children.map(cid=>{
    const s=(DB.users.student||{})[cid];
    const name=s? (s.name||cid) : cid;
    return '<option value="'+cid+'" '+(cid===parentChildId?'selected':'')+'>'+escapeHtml(name)+' ('+escapeHtml(cid)+')</option>';
  }).join("");
  renderParentChild();
}
function renderParentChild(){
  const area=document.getElementById("parentArea");
  const stu=(DB.users.student||{})[parentChildId];
  if(!stu){ area.innerHTML='<div class="notice">KhÃ´ng tÃ¬m tháº¥y há»c sinh: '+escapeHtml(parentChildId||"")+'</div>'; return; }
  area.innerHTML=renderReportCard(stu);
}
document.getElementById("selChild").addEventListener("change",(e)=>{ parentChildId=e.target.value; renderParentChild(); });
document.getElementById("btnShowWeekP").onclick=()=>renderParentChild();
document.getElementById("btnLinkChildQR").onclick=()=>openQRModal("link-child");
document.getElementById("btnRefreshP").onclick=()=>{ saveDB(DB); renderParentApp(); };
document.getElementById("btnLogoutP").onclick=()=>{ currentParentId=null; parentChildId=null; show("viewLogin"); toast("ÄÃ£ Ä‘Äƒng xuáº¥t"); };

</script>

<!-- QR MODALS -->
<div id="qrModal" class="overlay hidden" aria-hidden="true">
  <div class="modalCard">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="title" id="qrTitle">ÄÄƒng nháº­p báº±ng QR</div>
        <div class="small muted" id="qrHint">Cho phÃ©p camera, Ä‘Æ°a QR vÃ o khung.</div>
      </div>
      <button class="btn" id="btnCloseQR">âœ•</button>
    </div>
    <div class="hr"></div>
    <div id="qrReader" style="width:320px;max-width:100%;margin:10px auto;"></div>
    <div class="row" style="justify-content:center;margin-top:10px">
      <button class="btn" id="btnQRFromImage">ğŸ–¼ Chá»n áº£nh QR</button>
      <input id="qrImageInput" type="file" accept="image/*" class="hidden">
    </div>
    <div class="small muted" style="margin-top:10px;text-align:center">Náº¿u mÃ¡y báº¡n khÃ´ng há»— trá»£ camera, hÃ£y dÃ¹ng â€œChá»n áº£nh QRâ€.</div>
  </div>
</div>

<div id="myQRModal" class="overlay hidden" aria-hidden="true">
  <div class="modalCard">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div class="title">QR Ä‘Äƒng nháº­p</div>
        <div class="small muted">DÃ¹ng QR nÃ y Ä‘á»ƒ Ä‘Äƒng nháº­p nhanh trÃªn Ä‘iá»‡n thoáº¡i.</div>
      </div>
      <button class="btn" id="btnCloseMyQR">âœ•</button>
    </div>
    <div class="hr"></div>
    <div id="myQRCode" style="display:flex;justify-content:center;margin-top:8px;"></div>
    <div id="myQRText" class="small muted" style="margin-top:10px;word-break:break-all;text-align:center"></div>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

</body>
</html>
